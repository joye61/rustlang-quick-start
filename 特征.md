# Traitï¼ˆç‰¹å¾ï¼‰

> Trait æ˜¯ Rust çš„ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œç±»ä¼¼å…¶ä»–è¯­è¨€çš„â€œæ¥å£â€æˆ–â€œç±»å‹ç±»â€ã€‚å®ƒå®šä¹‰äº†ä¸€ç»„å¯ä»¥è¢«å®ç°çš„**è¡Œä¸ºè§„èŒƒ**ã€‚

---

## ğŸ”¹ ä»€ä¹ˆæ˜¯ Traitï¼Ÿ

Trait å°±æ˜¯ä¸€ä¸ªè¡Œä¸ºâ€œçº¦å®šâ€ï¼Œè°å®ç°äº†å®ƒï¼Œè°å°±å…·å¤‡äº†è¿™å¥—åŠŸèƒ½ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªå¯ä»¥â€œå«â€çš„ Traitï¼š

```rust
trait Speak {
    fn speak(&self);
}
```

### è°æ¥å®ç°ï¼Ÿ

```rust
struct Dog;

impl Speak for Dog {
    fn speak(&self) {
        println!("æ±ªæ±ªï¼");
    }
}
```

---

## ğŸ›  åŸºæœ¬è¯­æ³•

### å®šä¹‰ Trait

```rust
trait TraitName {
    fn method_name(&self); // æ— é»˜è®¤å®ç°
}
```

### å®ç° Trait

```rust
impl TraitName for TypeName {
    fn method_name(&self) {
        // å®ç°é€»è¾‘
    }
}
```

---

## ğŸŒŸ ç¤ºä¾‹ï¼šå®šä¹‰å’Œå®ç°ä¸€ä¸ª Trait

```rust
trait Hello {
    fn say_hello(&self);
}

struct Person;
struct Robot;

impl Hello for Person {
    fn say_hello(&self) {
        println!("ä½ å¥½ï¼Œæˆ‘æ˜¯äººç±»ï¼");
    }
}

impl Hello for Robot {
    fn say_hello(&self) {
        println!("ä½ å¥½ï¼Œæˆ‘æ˜¯æœºå™¨äººï¼");
    }
}

fn main() {
    let p = Person;
    let r = Robot;

    p.say_hello(); // ä½ å¥½ï¼Œæˆ‘æ˜¯äººç±»ï¼
    r.say_hello(); // ä½ å¥½ï¼Œæˆ‘æ˜¯æœºå™¨äººï¼
}
```

---

## ğŸ”¸ é»˜è®¤å®ç°

ä½ å¯ä»¥ä¸º trait æä¾›é»˜è®¤å®ç°ï¼Œè¿™æ ·å®ç°è€…å¯ä»¥é€‰æ‹©æ˜¯å¦è¦†ç›–å®ƒã€‚

```rust
trait Greet {
    fn greet(&self) {
        println!("Hello!");
    }
}

struct Cat;
impl Greet for Cat {} // ä½¿ç”¨é»˜è®¤å®ç°

fn main() {
    Cat.greet(); // Hello!
}
```

---

## ğŸ”¹ å¸¦è¿”å›å€¼çš„æ–¹æ³•

```rust
trait Area {
    fn area(&self) -> f64;
}

struct Circle {
    radius: f64,
}

impl Area for Circle {
    fn area(&self) -> f64 {
        std::f64::consts::PI * self.radius * self.radius
    }
}
```

---

## ğŸ§© å¤šä¸ª Trait çš„å®ç°

```rust
trait A {
    fn a(&self);
}

trait B {
    fn b(&self);
}

struct Thing;

impl A for Thing {
    fn a(&self) { println!("A"); }
}

impl B for Thing {
    fn b(&self) { println!("B"); }
}
```

---

## ğŸ¯ Trait Boundï¼ˆç‰¹å¾çº¦æŸï¼‰

å¯ä»¥å°† trait ä½œä¸ºå‡½æ•°å‚æ•°çš„ç±»å‹çº¦æŸï¼š

### å†™æ³• 1ï¼šåœ¨å‚æ•°å¤„ä½¿ç”¨ `impl Trait`

```rust
fn print_speak(x: impl Speak) {
    x.speak();
}
```

### å†™æ³• 2ï¼šä½¿ç”¨æ³›å‹ + `T: Trait`

```rust
fn print_speak<T: Speak>(x: T) {
    x.speak();
}
```

### å†™æ³• 3ï¼šä½¿ç”¨ where å­å¥ï¼ˆæ›´æ¸…æ™°ï¼‰

```rust
fn print_speak<T>(x: T)
where
    T: Speak,
{
    x.speak();
}
```

---

## ğŸ” å¤šä¸ª Trait Boundï¼ˆç»„åˆçº¦æŸï¼‰

```rust
fn show<T: Speak + std::fmt::Debug>(x: T) {
    x.speak();
    println!("{:?}", x);
}
```

---

## âœ… Trait Objectï¼ˆç‰¹å¾å¯¹è±¡ï¼‰

å¦‚æœä½ æƒ³è®©ä¸€ä¸ªå˜é‡â€œæŒ‡å‘ä¸åŒå®ç°ç±»å‹â€ï¼Œéœ€è¦ç”¨ **trait å¯¹è±¡ + åŠ¨æ€åˆ†å‘**ï¼š

```rust
trait Speak {
    fn speak(&self);
}

struct Dog;
impl Speak for Dog {
    fn speak(&self) { println!("ç‹—å«ï¼"); }
}

struct Cat;
impl Speak for Cat {
    fn speak(&self) { println!("çŒ«å«ï¼"); }
}

fn make_speak_list() -> Vec<Box<dyn Speak>> {
    vec![Box::new(Dog), Box::new(Cat)]
}

fn main() {
    for animal in make_speak_list() {
        animal.speak(); // åŠ¨æ€è°ƒç”¨
    }
}
```

### æ³¨æ„äº‹é¡¹ï¼š

* `Box<dyn Trait>` æ˜¯**ç‰¹å¾å¯¹è±¡**ï¼›
* åªæœ‰åœ¨ **Trait æ²¡æœ‰æ³›å‹å‚æ•°**æ—¶ï¼Œæ‰èƒ½ä½œä¸º trait å¯¹è±¡ï¼›
* è¿è¡Œæ—¶ä½¿ç”¨â€œåŠ¨æ€åˆ†å‘â€ï¼Œç¨æ…¢ä½†æ›´çµæ´»ã€‚

---

## ğŸš€ Trait ä½œä¸ºè¿”å›å€¼

```rust
fn make_speaker() -> impl Speak {
    Dog
}
```

âš ï¸ æ³¨æ„ï¼š`impl Trait` åªèƒ½è¿”å› **ä¸€ç§å®ç°ç±»å‹**ã€‚

---

## å…³è”ç±»å‹ï¼ˆAssociated Typesï¼‰

åœ¨ Trait ä¸­å®šä¹‰ç±»å‹å ä½ç¬¦ï¼š

```rust
trait Iterator {
    type Item;
    fn next(&mut self) -> Option<Self::Item>;
}
```

å®ç°æ—¶å¿…é¡»è¦æŒ‡å®š `Item` ç±»å‹ï¼š

```rust
struct Counter;

impl Iterator for Counter {
    type Item = i32;

    fn next(&mut self) -> Option<i32> {
        Some(42)
    }
}
```

## trait ç»§æ‰¿ï¼Ÿ

ç®€å•ç‚¹è¯´å°±æ˜¯ï¼š**ä¸€ä¸ª trait ç»§æ‰¿å¦ä¸€ä¸ª trait çš„èƒ½åŠ›**ã€‚

```rust
trait A {
    fn a(&self);
}

trait B: A {
    // è¿™é‡Œå¯ä»¥ç›´æ¥ç”¨ A çš„æ–¹æ³•
    fn b(&self) {
        println!("b calls a:");
        self.a(); // ç›´æ¥ç”¨ A çš„æ–¹æ³•
    }
}

```

ä½†å’Œå…¶ä»–ç¼–ç¨‹è¯­è¨€çš„é¢å‘å¯¹è±¡ç»§æ‰¿ä¸åŒçš„æ˜¯ï¼š**ä»»ä½•å®ç° B çš„ç±»å‹ï¼Œä¹Ÿå¿…é¡»åŒæ—¶å®ç° A**

### æ³›å‹ç»§æ‰¿çš„ç®€å•ä¾‹å­

```rust
struct MyType;

impl A for MyType {
    fn a(&self) { println!("hello from A"); }
}

impl B for MyType {}

fn main() {
    let t = MyType;
    t.b(); // è‡ªåŠ¨è°ƒç”¨ a()
}
```

å¿…é¡»åŒæ—¶ä¸º MyType ç±»å‹å®ç° A å’Œ Bï¼Œä¸‹é¢çš„å†™æ³•æ˜¯é”™è¯¯çš„ï¼š

```rust
struct MyType;

impl B for MyType {
    // é‡è¦ï¼šè¿™é‡Œå¹¶æ²¡æœ‰å®ç° Aï¼Œä¸èƒ½åœ¨Bå®ç°é‡Œé¢å®ç°Açš„æ–¹æ³•
    fn a(&self) { println!("hello from A"); }
}

fn main() {
    let t = MyType;
    t.b(); // è‡ªåŠ¨è°ƒç”¨ a()
}
```

---

## ğŸ“¦ ä½¿ç”¨æ ‡å‡†åº“ Trait

Rust æ ‡å‡†åº“ä¸­å¤§é‡ä½¿ç”¨ traitï¼Œæ¯”å¦‚ï¼š

| Trait           | ç”¨é€”               |
| --------------- | ---------------- |
| `Display`       | æ ¼å¼åŒ–è¾“å‡º `{}`       |
| `Debug`         | æ ¼å¼åŒ–è¾“å‡º `{:?}`     |
| `Clone`         | å…‹éš†               |
| `Copy`          | æ‹·è´               |
| `PartialEq`     | ç›¸ç­‰æ¯”è¾ƒ `==`        |
| `PartialOrd`    | å¤§å°æ¯”è¾ƒ `< > >= <=` |
| `From` / `Into` | ç±»å‹è½¬æ¢             |
| `Drop`          | è‡ªå®šä¹‰ææ„            |

### ç¤ºä¾‹ï¼šä¸ºè‡ªå®šä¹‰ç±»å‹å®ç° `Display`

```rust
use std::fmt;

struct Point { x: i32, y: i32 }

impl fmt::Display for Point {
    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {
        write!(f, "({}, {})", self.x, self.y)
    }
}

fn main() {
    let p = Point { x: 1, y: 2 };
    println!("{}", p); // (1, 2)
}
```

---

## Trait çš„é«˜çº§ç”¨æ³•æ¦‚è§ˆ

| ç”¨æ³•           | è¯´æ˜                          |
| ------------ | --------------------------- |
| é»˜è®¤æ–¹æ³•å®ç°       | æä¾›é»˜è®¤é€»è¾‘                      |
| é™æ€åˆ†å‘ vs åŠ¨æ€åˆ†å‘ | `impl Trait` vs `dyn Trait` |
| æ³›å‹çº¦æŸ         | `T: Trait`                  |
| where å­å¥     | `where T: Trait1 + Trait2`  |
| å…³è”ç±»å‹         | `type Item`                 |
| trait + æ³›å‹ç»„åˆ | `trait Iterator<T>`ï¼ˆç›®å‰ä¸ç¨³å®šï¼‰  |
| trait ç»§æ‰¿     | `trait B: A {}`             |
| trait çš„ç”Ÿå‘½å‘¨æœŸ  | `trait TraitName + 'a`      |


è¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®çš„é—®é¢˜ï¼Œåœ¨ Rust ä¸­ï¼š

> `impl Trait` ä½œä¸º**å‚æ•°**å’Œ**è¿”å›å€¼**æ—¶ç¡®å®éƒ½è¡¨ç¤ºå®ç°äº†æŸä¸ª trait çš„å…·ä½“ç±»å‹ï¼Œä½†å®ƒä»¬çš„**è§„åˆ™å¹¶ä¸å®Œå…¨ä¸€æ ·**ã€‚

---

## âœ… å…ˆçœ‹ç»“è®º

| ç”¨æ³•               | è¯´æ˜                                            |
| ---------------- | --------------------------------------------- |
| `impl Trait` å‚æ•°  | âœ… å¯ä»¥æ¥å—ä»»ä½•å®ç°äº†è¯¥ trait çš„å…·ä½“ç±»å‹ï¼Œ**å¯ä»¥æ˜¯å¤šä¸ªä¸åŒç±»å‹**ï¼ˆè°ƒç”¨è€…å†³å®šï¼‰ |
| `impl Trait` è¿”å›å€¼ | âŒ åªèƒ½è¿”å›**ä¸€ç§å…·ä½“ç±»å‹**ï¼ˆç¼–è¯‘å™¨å¿…é¡»èƒ½ç¡®å®šå”¯ä¸€ç±»å‹ï¼‰                |

---

## ğŸ“Œ ä¸€ã€ä½œä¸ºå‚æ•°ï¼š**å¯ä»¥æ˜¯ä¸åŒç±»å‹**

```rust
trait Shape {
    fn area(&self) -> f64;
}

struct Circle(f64);
struct Square(f64);

impl Shape for Circle {
    fn area(&self) -> f64 { 3.14 * self.0 * self.0 }
}

impl Shape for Square {
    fn area(&self) -> f64 { self.0 * self.0 }
}

// impl Trait ä½œä¸ºå‚æ•°
fn print_area(shape: impl Shape) {
    println!("é¢ç§¯æ˜¯ {}", shape.area());
}

fn main() {
    print_area(Circle(1.0)); // OK
    print_area(Square(2.0)); // ä¹ŸOK
}
```

### âœ… è§£é‡Šï¼š

* è¿™é‡Œçš„ `impl Shape` å…è®¸ä¼ å…¥ä»»æ„å®ç°äº† `Shape` çš„ç±»å‹ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨ä¸ºæ¯æ¬¡è°ƒç”¨ç”Ÿæˆå…·ä½“å®ç°ï¼ˆ**monomorphization**ï¼‰ã€‚
* æ‰€ä»¥ä½ å¯ä»¥ä¼ å…¥ `Circle`ã€`Square`ã€ç”šè‡³å…¶ä»–ä»»ä½•å®ç°äº† `Shape` çš„ç±»å‹ã€‚

---

## ğŸ“Œ äºŒã€ä½œä¸ºè¿”å›å€¼ï¼š**åªèƒ½è¿”å›ä¸€ä¸ªå…·ä½“ç±»å‹**

```rust
// é”™è¯¯ç¤ºä¾‹ï¼šè¿”å›å¤šç§ç±»å‹çš„ impl Trait
fn random_shape(flag: bool) -> impl Shape {
    if flag {
        Circle(1.0)
    } else {
        Square(2.0) // âŒ ç¼–è¯‘é”™è¯¯ï¼šè¿”å›äº†ä¸åŒç±»å‹
    }
}
```

### âŒ é”™è¯¯åŸå› ï¼š

* `impl Trait` è¿”å›å€¼åªèƒ½æ˜¯å•ä¸€å…·ä½“ç±»å‹ï¼Œç¼–è¯‘å™¨ä¸èƒ½æ¨å¯¼å‡ºâ€œä¸€ä¸ªå›ºå®šçš„ç±»å‹â€ã€‚
* å³ä½¿ `Circle` å’Œ `Square` éƒ½å®ç°äº† `Shape`ï¼Œä¹Ÿä¸è¡Œã€‚

---

## âœ… æ­£ç¡®æ›¿ä»£æ–¹æ¡ˆï¼šä½¿ç”¨ trait object

```rust
fn random_shape(flag: bool) -> Box<dyn Shape> {
    if flag {
        Box::new(Circle(1.0))
    } else {
        Box::new(Square(2.0))
    }
}
```

---

## ğŸ“¦ è¡¥å……ï¼šæ³›å‹ vs impl Trait å‚æ•°

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨æ³›å‹å†™æ³•ï¼Œå®ƒç­‰ä»·äº `impl Trait`ï¼š

```rust
// æ³›å‹å†™æ³•
fn print_area<T: Shape>(shape: T) {
    println!("é¢ç§¯æ˜¯ {}", shape.area());
}
```

> âœ… `impl Trait` å‚æ•°è¯­æ³•åªæ˜¯æ³›å‹å‚æ•°å†™æ³•çš„ç®€åŒ–å½¢å¼ï¼ŒåŠŸèƒ½å‡ ä¹ç­‰åŒã€‚

---

## ğŸ§  æ€»ç»“å¯¹æ¯”è¡¨

| ç”¨æ³•                | èƒ½å¦æ¥å—å¤šç§ç±»å‹  | ç¼–è¯‘æ—¶æ˜¯å¦å·²çŸ¥ | æ˜¯å¦ç”¨ trait å¯¹è±¡ | æ€§èƒ½                  |
| ----------------- | --------- | ------- | ------------ | ------------------- |
| `impl Trait` å‚æ•°   | âœ… æ˜¯       | âœ… æ˜¯     | âŒ é™æ€åˆ†å‘       | é«˜æ•ˆ                  |
| æ³›å‹å‚æ•° `<T: Trait>` | âœ… æ˜¯       | âœ… æ˜¯     | âŒ é™æ€åˆ†å‘       | é«˜æ•ˆ                  |
| `impl Trait` è¿”å›å€¼  | âŒ å¦ï¼ˆåªèƒ½ä¸€ç§ï¼‰ | âœ… æ˜¯     | âŒ é™æ€åˆ†å‘       | é«˜æ•ˆ                  |
| `Box<dyn Trait>`  | âœ… æ˜¯       | âŒ ä¸ç¡®å®š   | âœ… åŠ¨æ€åˆ†å‘       | æœ‰æŸæ€§èƒ½ï¼ˆheap + vtableï¼‰ |

---

å¦‚æœä½ è¿˜æƒ³äº†è§£ `impl Trait` ä¸ `dyn Trait` åœ¨å¼‚æ­¥å‡½æ•°ã€é—­åŒ…è¿”å›å€¼æˆ– trait bounds ä¸­çš„åº”ç”¨ï¼Œæˆ‘å¯ä»¥ç»§ç»­å±•å¼€è®²è§£ã€‚

ä¸‹é¢æ˜¯ä¸€ç¯‡å…¨é¢è¯¦è§£ **`impl Trait` ä¸ `dyn Trait` åœ¨å„ç§åœºæ™¯ä¸­å¼‚åŒ** çš„æ•™ç¨‹ã€‚æˆ‘ä»¬å°†æŒ‰ä»¥ä¸‹ç»“æ„æ¥ç»„ç»‡å†…å®¹ï¼Œè¦†ç›–æ‰€æœ‰é‡è¦çŸ¥è¯†ç‚¹å¹¶é™„å¸¦ç¤ºä¾‹ï¼Œç¡®ä¿ä½ ç†è§£å¾—é€šé€ï¼š

---

## ğŸ§­ æ€»è§ˆï¼šä»€ä¹ˆæ˜¯ `impl Trait` ä¸ `dyn Trait`

| é¡¹ç›®    | `impl Trait`               | `dyn Trait`                        |
| ----- | -------------------------- | ---------------------------------- |
| æ‰€å±èŒƒç•´  | **é™æ€åˆ†å‘**ï¼šç¼–è¯‘æœŸç¡®å®šå…·ä½“ç±»å‹         | **åŠ¨æ€åˆ†å‘**ï¼šè¿è¡Œæ—¶é€šè¿‡ vtable å®ç°å¤šæ€         |
| ç¼–è¯‘å™¨è¡Œä¸º | monomorphizationï¼ˆç”Ÿæˆå¤šä»½ä¸“ç”¨ä»£ç ï¼‰ | trait objectï¼ˆé€šè¿‡å¼•ç”¨æˆ–æŒ‡é’ˆé—´æ¥è°ƒç”¨ï¼‰          |
| æ€§èƒ½    | âœ… å¿«ï¼ˆç¼–è¯‘æœŸä¼˜åŒ–ï¼‰                 | âŒ æ…¢ï¼ˆè¿è¡ŒæœŸæŸ¥æ‰¾å‡½æ•°è¡¨ï¼‰                      |
| ç±»å‹å¤§å°  | âœ… å·²çŸ¥ï¼Œ`Sized`               | âŒ ä¸å®šï¼Œ`?Sized`ï¼Œå¿…é¡»é€šè¿‡æŒ‡é’ˆï¼ˆå¦‚ `&`, `Box`ï¼‰ |
| å¤šæ€æ”¯æŒ  | âœ… æ³›å‹å¤šæ€                     | âœ… è¿è¡Œæ—¶å¤šæ€                            |
| ä½¿ç”¨è¯­å¢ƒ  | è¿”å›å€¼ã€å‚æ•°ã€æ³›å‹                  | trait object ä¼ å‚ã€å­˜å‚¨åˆ°é›†åˆã€å¼‚æ­¥åŠ¨æ€è¡Œä¸º       |

---

## âœ¨ ä¸€ã€å‡½æ•°å‚æ•°ä¸­çš„ä½¿ç”¨

### âœ… impl Traitï¼šé™æ€åˆ†å‘ã€æ³›å‹æ–¹å¼

```rust
trait Speak {
    fn speak(&self);
}

fn talk(animal: impl Speak) {
    animal.speak();
}
```

ç¼–è¯‘æ—¶å†³å®šå…·ä½“ç±»å‹ï¼Œ**æ•ˆç‡é«˜ã€é™åˆ¶ä¹Ÿå¤§**ï¼Œä¸åŒç±»å‹æ— æ³•æ”¾å…¥åŒä¸€é›†åˆä¸­ã€‚

---

### âœ… dyn Traitï¼šåŠ¨æ€åˆ†å‘ã€å¤šæ€è¡Œä¸º

```rust
fn talk(animal: &dyn Speak) {
    animal.speak();
}
```

* æ”¯æŒ **è¿è¡Œæ—¶å¤šæ€**
* å¯ä»¥æ¥å—ä¸åŒç±»å‹çš„å‚æ•°ï¼ˆåªè¦å®ç°äº† `Speak`ï¼‰

---

## ğŸ§¾ äºŒã€å‡½æ•°è¿”å›å€¼ä¸­çš„ä½¿ç”¨

### âœ… impl Trait è¿”å›å€¼ï¼šé€‚ç”¨äºå•ä¸€å…·ä½“ç±»å‹

```rust
fn get_speaker() -> impl Speak {
    Dog {} // åªèƒ½è¿”å›ä¸€ä¸ªå…·ä½“ç±»å‹
}
```

* è¿”å›å€¼å¿…é¡»æ˜¯ **å•ä¸€å…·ä½“ç±»å‹**
* ç¼–è¯‘æœŸç”Ÿæˆä¸“é—¨ç‰ˆæœ¬
* æ— æ³•åœ¨è¿è¡Œæ—¶å†³å®šè¿”å›ç±»å‹

### âŒ é”™è¯¯ç¤ºä¾‹ï¼š

```rust
fn get_speaker(dog: bool) -> impl Speak {
    if dog {
        Dog {}
    } else {
        Cat {}
    } // âŒ ä¸åŒç±»å‹ï¼Œç¼–è¯‘å¤±è´¥
}
```

---

### âœ… dyn Trait è¿”å›å€¼ï¼šæ”¯æŒä¸åŒç±»å‹è¿”å›ï¼ˆåŠ¨æ€åˆ†å‘ï¼‰

```rust
fn get_speaker(dog: bool) -> Box<dyn Speak> {
    if dog {
        Box::new(Dog {})
    } else {
        Box::new(Cat {})
    }
}
```

* ä½¿ç”¨ trait object å°è£…ä¸åŒç±»å‹
* å¯æ”¾å…¥ `Box`ã€`Rc`ã€`Arc` ç­‰æ™ºèƒ½æŒ‡é’ˆä¸­
* æ”¯æŒå¼‚æ­¥ã€æ’ä»¶ç³»ç»Ÿç­‰åœºæ™¯

---

## ğŸ“¦ ä¸‰ã€å®¹å™¨ä¸é›†åˆä¸­çš„ä½¿ç”¨

```rust
let animals: Vec<Box<dyn Speak>> = vec![Box::new(Dog {}), Box::new(Cat {})]; // âœ… æ”¯æŒ
```

* **`dyn Trait`** å¯ä»¥æ”¾è¿› `Vec`ï¼Œé€‚åˆå­˜å‚¨ä¸åŒç±»å‹
* `impl Trait` / æ³›å‹ **ä¸èƒ½æ”¾å…¥å®¹å™¨**

---

## ğŸš€ å››ã€å¼‚æ­¥å‡½æ•°è¿”å›å€¼åœºæ™¯ï¼ˆasync + traitï¼‰

ç”±äº Rust ä¸æ”¯æŒ `async fn` è¿”å› `impl Trait` å¤šç±»å‹ï¼ˆé™¤éåŠ  Boxï¼‰ï¼Œè¿™å°±è¦ç”¨åˆ° `dyn Trait`ã€‚

```rust
async fn foo() -> impl Future<Output = i32> {
    42
}
```

### è¿”å› trait objectï¼š

```rust
fn make_future() -> Pin<Box<dyn Future<Output = i32>>> {
    Box::pin(async { 42 })
}
```

* `Box<dyn Future>` æ˜¯æ”¯æŒå¼‚æ­¥ trait object çš„å¸¸è§å†™æ³•
* `dyn Future` æœ¬è´¨ä¹Ÿæ˜¯ `dyn Trait`

---

## ğŸ§  äº”ã€ä½œä¸ºç»“æ„ä½“å­—æ®µçš„ä½¿ç”¨

### âŒ impl Trait ä¸èƒ½ç”¨äºç»“æ„ä½“å­—æ®µï¼ˆä¸å…è®¸æŠ½è±¡ï¼‰

```rust
struct Speaker {
    speaker: impl Speak, // âŒ ä¸åˆæ³•
}
```

### âœ… dyn Trait å¯ä»¥ï¼š

```rust
struct Speaker {
    speaker: Box<dyn Speak>, // âœ… OK
}
```

ç”¨äºå°è£…ä¸åŒå®ç°è€…ã€‚

---

## ğŸ”„ å…­ã€ç»„åˆ Traitï¼ˆTrait Boundï¼‰

`impl Trait` / æ³›å‹æ”¯æŒ trait ç»„åˆï¼š

```rust
fn handle<T: Read + Write>(io: T) { ... }

fn handle2(io: impl Read + Write) { ... }
```

è€Œ `dyn Trait` çš„ç»„åˆè¯­æ³•ç•¥å¤æ‚ï¼š

```rust
fn handle(io: &mut (dyn Read + Write)) { ... }
```

ç»„åˆ trait object ç±»å‹ï¼š`dyn Trait1 + Trait2`

---

## âš–ï¸ ä¸ƒã€æ€»ç»“å¯¹æ¯”è¡¨

| åœºæ™¯          | `impl Trait` | `dyn Trait`               |
| ----------- | ------------ | ------------------------- |
| ç”¨ä½œå‡½æ•°å‚æ•°      | âœ… æ³›å‹å½¢å¼       | âœ… å¤šæ€å½¢å¼                    |
| ç”¨ä½œå‡½æ•°è¿”å›å€¼     | âœ… ä½†ç±»å‹å¿…é¡»å”¯ä¸€    | âœ… æ”¯æŒå¤šç±»å‹ï¼ˆéœ€ Box åŒ…è£…ï¼‰         |
| æ”¾å…¥é›†åˆï¼ˆå¦‚ Vecï¼‰ | âŒ ä¸æ”¯æŒ        | âœ… æ”¯æŒ                      |
| ä½œä¸ºç»“æ„ä½“å­—æ®µ     | âŒ ä¸æ”¯æŒ        | âœ… é€šè¿‡ `Box`ã€`&` ç­‰          |
| æ€§èƒ½          | é«˜æ•ˆï¼Œç¼–è¯‘æ—¶å±•å¼€     | ç¨æ…¢ï¼Œè¿è¡Œæ—¶åˆ†å‘                  |
| æ˜¯å¦æ”¯æŒå¤šç§å®ç°è€…   | âŒï¼ˆæ¯æ¬¡ä¸€ä¸ªï¼‰      | âœ…ï¼ˆè¿è¡Œæ—¶é€‰æ‹©ï¼‰                  |
| å¼‚æ­¥å…¼å®¹æ€§       | âœ…ï¼Œä½†è¿”å›å€¼æœ‰é™åˆ¶    | âœ…ï¼Œ`Box<dyn Future>` æœ€å¸¸ç”¨å½¢å¼ |
| æ˜¯å¦ Sized    | âœ… æ˜¯ Sized ç±»å‹ | âŒ ä¸æ˜¯ Sized ç±»å‹ï¼ˆéœ€å¼•ç”¨æˆ– Boxï¼‰   |

---

## ğŸ”š æ€»ç»“å»ºè®®ï¼šé€‰æ‹©ä½•ç§æ–¹å¼ï¼Ÿ

| éœ€æ±‚/ç›®çš„           | å»ºè®®æ–¹å¼              | ç†ç”±                          |
| --------------- | ----------------- | --------------------------- |
| åªå¤„ç†ä¸€ä¸ªå…·ä½“å®ç°ç±»å‹     | `impl Trait`      | æ›´ç®€å•é«˜æ•ˆ                       |
| éœ€è¦å­˜å‚¨å¤šç§å®ç°è€…       | `Box<dyn Trait>`  | trait object æ”¯æŒå¤šæ€ï¼Œé€‚åˆå®¹å™¨ã€æ’ä»¶ç³»ç»Ÿ |
| å¸Œæœ›éšè—ç±»å‹å®ç°ç»†èŠ‚      | `impl Trait`      | å°è£…åº“æ¥å£å¸¸è§ç”¨é€”                   |
| è¦è¿”å›ä¸åŒå®ç°è€…ç±»å‹ä¹‹ä¸€    | `Box<dyn Trait>`  | `impl Trait` ä¸èƒ½è¿”å›å¤šç§ç±»å‹       |
| å¼‚æ­¥å‡½æ•°è¿”å›å€¼         | `Box<dyn Future>` | å¿…é¡»ä½¿ç”¨ trait object           |
| éœ€è¦ç»„åˆå¤šä¸ª trait èƒ½åŠ› | `impl Trait +`    | trait bound çµæ´»ï¼Œå¯ç»„åˆä½¿ç”¨        |

---

å¦‚ä½ æœ‰å…·ä½“é¡¹ç›®ç»“æ„ï¼ˆæ¯”å¦‚ GUI æ’ä»¶ç³»ç»Ÿã€å›¾å½¢åç«¯ã€AI æ¨¡å‹ç­‰ï¼‰ï¼Œæˆ‘å¯ä»¥è¿›ä¸€æ­¥å®šåˆ¶è§£é‡Š `impl Trait` ä¸ `dyn Trait` çš„é€‰æ‹©å»ºè®®å’Œå†™æ³•ã€‚éœ€è¦æˆ‘æ·±å…¥å“ªä¸ªæ–¹å‘ï¼Ÿ

