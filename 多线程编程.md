## å¤šçº¿ç¨‹ç¼–ç¨‹

### äºŒã€åŸºç¡€ï¼šåˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼ˆ30 ç§’ä¸Šæ‰‹ï¼‰
Rust ç”¨ `std::thread` æ¨¡å—åˆ›å»ºçº¿ç¨‹ï¼Œæ ¸å¿ƒå‡½æ•°æ˜¯ `spawn`ã€‚

#### ç¤ºä¾‹ 1ï¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹
```rust
use std::thread;

fn main() {
    let handle = thread::spawn(|| {
        println!("Hello from another thread!");
    });

    // ç­‰å¾…å­çº¿ç¨‹ç»“æŸ
    handle.join().unwrap();
    println!("Main thread done.");
}

```

- **å…³é”®ç‚¹**ï¼š
  - `thread::spawn(|| { ... })`ï¼šå¯åŠ¨æ–°çº¿ç¨‹ï¼Œé‡Œé¢æ˜¯ **é—­åŒ…**ï¼ˆç±»ä¼¼åŒ¿åå‡½æ•°ï¼‰
  - `handle.join()`ï¼šä¸»çº¿ç¨‹ **ç­‰å¾…å­çº¿ç¨‹ç»“æŸ**ï¼ˆä¸åŠ è¿™å¥ï¼Œä¸»çº¿ç¨‹ç»“æŸæ—¶å­çº¿ç¨‹ä¼šè¢«æ€æ‰ï¼ï¼‰

> âš ï¸ **å¸¸è§å‘**ï¼šå¿˜è®° `join()` â†’ å­çº¿ç¨‹æ²¡æ‰§è¡Œå®Œå°±è¢«ç»ˆæ­¢ã€‚**è®°ä½ï¼šçº¿ç¨‹åƒå­©å­ï¼Œä¸»çº¿ç¨‹æ˜¯å®¶é•¿ï¼Œå¿…é¡»ç­‰å­©å­å›å®¶ï¼**

---

### ä¸‰ã€æ ¸å¿ƒéš¾é¢˜ï¼šå¦‚ä½•å®‰å…¨å…±äº«æ•°æ®ï¼Ÿï¼ˆæ‰€æœ‰æƒç³»ç»Ÿå¤§æ˜¾ç¥å¨ï¼‰
#### çº¿ç¨‹ä¸èƒ½ç›´æ¥å€Ÿç”¨å¤–éƒ¨å˜é‡
```rust
fn main() {
    let s = String::from("Rust");
    let handle = thread::spawn(|| {
        println!("å­çº¿ç¨‹: {}", s); // ç¼–è¯‘é”™è¯¯ï¼
    });
    handle.join().unwrap();
}
```
**é”™è¯¯ä¿¡æ¯**ï¼š  
`error[E0373]: closure may outlive the current function`  
ï¼ˆé—­åŒ…ç”Ÿå‘½å‘¨æœŸå¯èƒ½æ¯”å½“å‰å‡½æ•°é•¿ï¼ŒRust ä¸å…è®¸è¿™æ ·å€Ÿç”¨æ•°æ®ï¼‰

> **ä¸ºä»€ä¹ˆï¼Ÿ**  
> `s` å¯èƒ½åœ¨åˆ›å»ºå®ƒçš„ä½œç”¨åŸŸç»“æŸåè¢«æ¸…ç†ï¼Œè€Œå­çº¿ç¨‹è¿˜åœ¨ç”¨ `s`ï¼Œå¯¼è‡´ **æ‚¬å‚æŒ‡é’ˆ**ï¼ˆè®¿é—®æ— æ•ˆå†…å­˜ï¼‰

- thread::spawn é»˜è®¤è¦æ±‚ä¼ å…¥çš„é—­åŒ…æ˜¯ 'static ç”Ÿå‘½å‘¨æœŸ çš„ï¼ˆæ„æ€æ˜¯é—­åŒ…é‡Œä¸èƒ½æ•è·ä»…å­˜åœ¨äºå½“å‰å‡½æ•°æ ˆä¸Šçš„å¼•ç”¨ï¼‰ã€‚
- s æ˜¯ main å‡½æ•°é‡Œçš„å±€éƒ¨å˜é‡ï¼Œç”Ÿå‘½å‘¨æœŸåªåˆ° main ç»“æŸã€‚
- å¦‚æœé—­åŒ…æ•è·äº† s çš„å¼•ç”¨ï¼Œé‚£ä¹ˆå­çº¿ç¨‹å¯èƒ½æ¯” main æ´»å¾—ä¹…ï¼Œå°±ä¼šå‡ºç°æ‚¬å‚å¼•ç”¨ï¼ˆdangling referenceï¼‰çš„é£é™©ã€‚
- Rust ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé˜»æ­¢äº†è¿™ç§ä¸å®‰å…¨æƒ…å†µï¼Œæ‰€ä»¥æŠ¥é”™ã€‚

Rust ä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œè¦æ±‚ï¼š

- é—­åŒ…ä¸­ä½¿ç”¨çš„å¤–éƒ¨æ•°æ®å¿…é¡» 'staticï¼ˆä¸ä¾èµ–æ ˆä¸Šçš„ä¸´æ—¶æ•°æ®ï¼‰ï¼Œ
- æˆ–è€…ä½ æ˜¾å¼è½¬ç§»æ‰€æœ‰æƒï¼ˆmove é—­åŒ…ï¼‰ã€‚

#### ä½œç”¨åŸŸçº¿ç¨‹ï¼š`thread::scope`

```rust
use std::thread;

fn main() {
    let msg = String::from("Hi");
    thread::scope(|s| {
        s.spawn(|| {
            println!("{}", msg);
        });
    });
}
```

å¯ä»¥å®‰å…¨åœ°å€Ÿç”¨å±€éƒ¨å˜é‡ï¼Œä¸å¿… 'staticã€‚ä½œç”¨åŸŸç»“æŸå‰ä¼šè‡ªåŠ¨ç­‰å¾…å­çº¿ç¨‹ç»“æŸã€‚

#### è§£æ³• 1ï¼šç”¨ `move` å…³é”®å­—è½¬ç§»æ‰€æœ‰æƒï¼ˆæœ€å¸¸ç”¨ï¼ï¼‰
```rust
fn main() {
    let s = String::from("Rust");
    // ç”¨ move æŠŠ s çš„æ‰€æœ‰æƒè½¬ç§»åˆ°å­çº¿ç¨‹
    let handle = thread::spawn(move || {
        println!("å­çº¿ç¨‹: {}", s); // æ­£ç¡®ï¼s ç°åœ¨å±äºå­çº¿ç¨‹
    });
    handle.join().unwrap();
    // println!("{}", s); // é”™è¯¯ï¼s å·²è¢«ç§»èµ°
}
```
- **`move` çš„ä½œç”¨**ï¼šå¼ºåˆ¶é—­åŒ…è·å–å¤–éƒ¨å˜é‡çš„æ‰€æœ‰æƒï¼ˆè€Œéå€Ÿç”¨ï¼‰
- **ä»£ä»·**ï¼šä¸»çº¿ç¨‹ä¸èƒ½å†ç”¨ `s`ï¼ˆæ‰€æœ‰æƒè½¬ç§»äº†ï¼‰

#### è§£æ³• 2ï¼šä½†æˆ‘æƒ³å¤šä¸ªçº¿ç¨‹å…±äº«æ•°æ®æ€ä¹ˆåŠï¼Ÿ
â†’ è¿™æ—¶éœ€è¦ **åŒæ­¥åŸè¯­**ï¼ˆSync Primitivesï¼‰ï¼Œä¸‹é¢é‡ç‚¹è®²ï¼

---

### å››ã€åŒæ­¥åŸè¯­ï¼šå®‰å…¨å…±äº«æ•°æ®çš„ä¸‰å¤§æ³•å®
#### æ³•å® 1ï¼š`Mutex`ï¼ˆäº’æ–¥é”ï¼‰â€”â€” "å•æ‰€å•é—´é”"
- **ä½œç”¨**ï¼šç¡®ä¿åŒä¸€æ—¶é—´ **åªæœ‰ä¸€ä¸ªçº¿ç¨‹** èƒ½è®¿é—®æ•°æ®
- **ç”Ÿæ´»æ¯”å–»**ï¼šå…¬å…±å•æ‰€å•é—´ï¼Œé—¨ä¸ŠæŒ‚é”ã€‚è¿›å»æ—¶é”é—¨ï¼ˆ`lock`ï¼‰ï¼Œå‡ºæ¥æ—¶å¼€é—¨ï¼ˆè‡ªåŠ¨é‡Šæ”¾ï¼‰

##### ç¤ºä¾‹ 2ï¼šç”¨ `Mutex` å…±äº«è®¡æ•°å™¨
```rust
use std::sync::Mutex;
use std::thread;

fn main() {
    // åˆ›å»ºä¸€ä¸ªè¢« Mutex ä¿æŠ¤çš„è®¡æ•°å™¨
    let counter = Mutex::new(0);
    let mut handles = vec![];

    // å¯åŠ¨ 5 ä¸ªçº¿ç¨‹
    for _ in 0..5 {
        let handle = thread::spawn(move || {
            // åŠ é”ï¼ˆå¦‚æœé”è¢«å ç”¨ï¼Œçº¿ç¨‹ä¼šé˜»å¡ç­‰å¾…ï¼‰
            let mut num = counter.lock().unwrap();
            *num += 1; // ä¿®æ”¹æ•°æ®
            // é”åœ¨è¿™é‡Œè‡ªåŠ¨é‡Šæ”¾ï¼ˆRAII æœºåˆ¶ï¼Œç¦»å¼€ä½œç”¨åŸŸå³é‡Šæ”¾ï¼‰
        });
        handles.push(handle);
    }

    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ
    for handle in handles {
        handle.join().unwrap();
    }

    println!("æœ€ç»ˆè®¡æ•°: {}", *counter.lock().unwrap());
}
```
**è¾“å‡º**ï¼š`æœ€ç»ˆè®¡æ•°: 5`ï¼ˆæ€»æ˜¯æ­£ç¡®ï¼ï¼‰

- **å…³é”®ç‚¹**ï¼š
  - `Mutex::new(0)`ï¼šåˆ›å»ºå¸¦é”çš„æ•°æ®
  - `counter.lock()`ï¼šå°è¯•åŠ é”ï¼ˆ**é˜»å¡**ç›´åˆ°æ‹¿åˆ°é”ï¼‰
  - **è‡ªåŠ¨é‡Šæ”¾**ï¼šRust ç”¨ **RAII**ï¼ˆèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰ç¡®ä¿é”åœ¨ä½œç”¨åŸŸç»“æŸæ—¶é‡Šæ”¾ï¼ˆä¸ç”¨æ‰‹åŠ¨ unlockï¼ï¼‰
  - `.unwrap()`ï¼šå¤„ç†å¯èƒ½çš„é”™è¯¯ï¼ˆå¦‚é”è¢«æ±¡æŸ“ï¼‰

> âš ï¸ **æ­»é”è­¦å‘Š**ï¼š  
> å¦‚æœçº¿ç¨‹ A æ‹¿ç€é” 1 ç­‰é” 2ï¼Œçº¿ç¨‹ B æ‹¿ç€é” 2 ç­‰é” 1 â†’ **æ­»é”**ï¼ˆç¨‹åºå¡æ­»ï¼‰  
> **é¿å…æŠ€å·§**ï¼š  
> 1. é”çš„é¡ºåºä¸€è‡´ï¼ˆæ¯”å¦‚éƒ½å…ˆé” 1 å†é” 2ï¼‰  
> 2. é”çš„èŒƒå›´å°½é‡å°ï¼ˆåªé”å¿…è¦ä»£ç ï¼‰

---

#### æ³•å® 2ï¼š`Arc`ï¼ˆåŸå­å¼•ç”¨è®¡æ•°ï¼‰â€”â€” "å…±äº«æ±½è½¦é’¥åŒ™"
- **é—®é¢˜**ï¼š`Mutex` æœ¬èº«ä¸èƒ½è·¨çº¿ç¨‹å…±äº«ï¼ˆå› ä¸ºä¸å®‰å…¨ï¼‰
- **è§£æ³•**ï¼š`Arc`ï¼ˆ`Atomic Reference Counting`ï¼‰è®©å¤šä¸ªçº¿ç¨‹å®‰å…¨æŒæœ‰ `Mutex`
- **ç”Ÿæ´»æ¯”å–»**ï¼šå…±äº«æ±½è½¦ï¼Œ`Arc` æ˜¯ç”µå­é’¥åŒ™ç³»ç»Ÿã€‚æ¯æ¬¡å€Ÿè½¦ï¼ˆ`clone`ï¼‰è®¡æ•°+1ï¼Œè¿˜è½¦è®¡æ•°-1ï¼Œå½’é›¶æ—¶é”€æ¯è½¦

##### ç¤ºä¾‹ 3ï¼š`Arc` + `Mutex` å…±äº«æ•°æ®
```rust
use std::sync::{Arc, Mutex};
use std::thread;

fn main() {
    // ç”¨ Arc åŒ…è£¹ Mutexï¼Œä½¿å…¶å¯è·¨çº¿ç¨‹å…±äº«
    let counter = Arc::new(Mutex::new(0));
    let mut handles = vec![];

    for _ in 0..10 {
        // æ¯ä¸ªçº¿ç¨‹æ‹¿åˆ° counter çš„ä¸€ä¸ªå…‹éš†ï¼ˆå¼•ç”¨è®¡æ•°+1ï¼‰
        let counter = Arc::clone(&counter);
        let handle = thread::spawn(move || {
            let mut num = counter.lock().unwrap();
            *num += 1;
        });
        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }

    println!("æœ€ç»ˆè®¡æ•°: {}", *counter.lock().unwrap());
}
```
- **å…³é”®ç‚¹**ï¼š
  - `Arc::new()`ï¼šåˆ›å»ºå¯å…±äº«çš„æ™ºèƒ½æŒ‡é’ˆ
  - `Arc::clone(&counter)`ï¼šå…‹éš†æŒ‡é’ˆï¼ˆ**ä¸å¤åˆ¶æ•°æ®**ï¼Œåªå¢åŠ å¼•ç”¨è®¡æ•°ï¼‰
  - **ä¸ºä»€ä¹ˆéœ€è¦ Arc**ï¼Ÿ  
    `Mutex` å®ç°äº† `Send` å’Œ `Sync` traitï¼Œä½†æ™®é€š `Mutex` ä¸èƒ½è·¨çº¿ç¨‹ä¼ é€’ï¼ˆæ‰€æœ‰æƒé—®é¢˜ï¼‰ã€‚`Arc` æä¾›çº¿ç¨‹å®‰å…¨çš„å¼•ç”¨è®¡æ•°ã€‚

> ğŸ’¡ **æŠ€æœ¯ç»†èŠ‚**ï¼š  
> - `Arc` æ˜¯ **åŸå­æ“ä½œ**ï¼ˆCPU æŒ‡ä»¤çº§å®‰å…¨ï¼‰ï¼Œé¿å…å¤šçº¿ç¨‹ä¿®æ”¹è®¡æ•°æ—¶å‡ºé”™  
> - ä¸ `Rc`ï¼ˆå•çº¿ç¨‹å¼•ç”¨è®¡æ•°ï¼‰åŒºåˆ«ï¼š`Rc` ä¸å®‰å…¨ï¼Œå¤šçº¿ç¨‹ä¼šå´©æºƒ

---

#### æ³•å® 3ï¼š`RwLock`ï¼ˆè¯»å†™é”ï¼‰â€”â€” "å›¾ä¹¦é¦†æ¨¡å¼"
- **åœºæ™¯**ï¼šè¯»å¤šå†™å°‘ï¼ˆæ¯”å¦‚é…ç½®æ•°æ®ï¼‰
- **è§„åˆ™**ï¼š
  - ä»»æ„æ•°é‡çº¿ç¨‹å¯ **åŒæ—¶è¯»**ï¼ˆ`read`ï¼‰
  - å†™æ—¶ **ç‹¬å **ï¼ˆ`write`ï¼‰ï¼Œå…¶ä»–è¯»å†™é˜»å¡
- **ç”Ÿæ´»æ¯”å–»**ï¼šå›¾ä¹¦é¦†  
  - è¯»è€…ï¼ˆreadï¼‰ï¼šå¤šäººåŒæ—¶çœ‹ä¹¦  
  - ä½œè€…ï¼ˆwriteï¼‰ï¼šä¿®æ”¹ä¹¦ç±æ—¶ï¼Œç¦æ­¢æ‰€æœ‰äººè¿›å…¥

##### ç¤ºä¾‹ 4ï¼šç”¨ `RwLock` ä¼˜åŒ–è¯»æ“ä½œ
```rust
use std::sync::RwLock;
use std::thread;

fn main() {
    let data = RwLock::new(vec![1, 2, 3]);
    
    // 5 ä¸ªè¯»çº¿ç¨‹
    let mut readers = vec![];
    for _ in 0..5 {
        let data = data.clone();
        readers.push(thread::spawn(move || {
            let d = data.read().unwrap(); // å¤šä¸ªçº¿ç¨‹å¯åŒæ—¶è¯»
            println!("è¯»çº¿ç¨‹: {:?}", *d);
        }));
    }

    // 1 ä¸ªå†™çº¿ç¨‹
    let writer = thread::spawn(move || {
        let mut d = data.write().unwrap(); // å†™æ—¶ç‹¬å 
        d.push(4);
        println!("å†™çº¿ç¨‹: å·²æ›´æ–°");
    });

    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹
    for r in readers {
        r.join().unwrap();
    }
    writer.join().unwrap();
}
```
**è¾“å‡º**ï¼ˆè¯»çº¿ç¨‹å¯èƒ½å¹¶è¡Œæ‰§è¡Œï¼‰ï¼š
```
è¯»çº¿ç¨‹: [1, 2, 3]
è¯»çº¿ç¨‹: [1, 2, 3]
...ï¼ˆå…¶ä»–è¯»çº¿ç¨‹ï¼‰
å†™çº¿ç¨‹: å·²æ›´æ–°
```
- **ä¸ `Mutex` å¯¹æ¯”**ï¼š  
  | é”ç±»å‹ | è¯»æ€§èƒ½ | å†™æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
  |--------|--------|--------|----------|
  | `Mutex` | ä½ï¼ˆæ¯æ¬¡åªèƒ½ä¸€ä¸ªçº¿ç¨‹ï¼‰ | ä½ | è¯»å†™å‡è¡¡ |
  | `RwLock` | é«˜ï¼ˆå¤šè¯»å¹¶å‘ï¼‰ | ä½ï¼ˆå†™æ—¶é˜»å¡æ‰€æœ‰ï¼‰ | è¯»å¤šå†™å°‘ |

> âš ï¸ **æ³¨æ„**ï¼š  
> - å†™é”ä¼˜å…ˆçº§é«˜ï¼Œå¯èƒ½å¯¼è‡´ **å†™é¥¥é¥¿**ï¼ˆä¸€ç›´æœ‰è¯»çº¿ç¨‹ï¼Œå†™çº¿ç¨‹ç­‰ä¸åˆ°ï¼‰  
> - æ“ä½œç³»ç»Ÿä¼šè°ƒåº¦ï¼Œä½†æç«¯æƒ…å†µéœ€æ‰‹åŠ¨å¤„ç†

---

### äº”ã€æ›´å®‰å…¨çš„æ–¹å¼ï¼šæ¶ˆæ¯ä¼ é€’ï¼ˆChannelsï¼‰
Rust **å®˜æ–¹æ¨è**ï¼šä¼˜å…ˆç”¨ **æ¶ˆæ¯ä¼ é€’** è€Œéå…±äº«çŠ¶æ€ï¼  
æ ¸å¿ƒï¼š`std::sync::mpsc`ï¼ˆå¤šç”Ÿäº§è€…å•æ¶ˆè´¹è€…é€šé“ï¼‰

#### ç”Ÿæ´»æ¯”å–»
- **é€šé“** = é‚®ç­’  
- **ç”Ÿäº§è€…** = å¯„ä¿¡äººï¼ˆ`Sender`ï¼‰  
- **æ¶ˆè´¹è€…** = æ”¶ä¿¡äººï¼ˆ`Receiver`ï¼‰  
- **æ¶ˆæ¯** = ä¿¡ä»¶ï¼ˆæ‰€æœ‰æƒè½¬ç§»ï¼Œå®‰å…¨ï¼ï¼‰

##### ç¤ºä¾‹ 5ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹
```rust
use std::sync::mpsc;
use std::thread;

fn main() {
    // åˆ›å»ºé€šé“ï¼štx æ˜¯å‘ä¿¡ç«¯ï¼Œrx æ˜¯æ”¶ä¿¡ç«¯
    let (tx, rx) = mpsc::channel();

    // å¯åŠ¨æ¶ˆè´¹è€…çº¿ç¨‹
    let handle = thread::spawn(move || {
        // rx.recv() é˜»å¡ç­‰å¾…æ¶ˆæ¯
        let msg = rx.recv().unwrap();
        println!("æ”¶åˆ°æ¶ˆæ¯: {}", msg);
    });

    // ç”Ÿäº§è€…å‘é€æ¶ˆæ¯
    tx.send("Hello from main!").unwrap();

    handle.join().unwrap();
}
```
**è¾“å‡º**ï¼š`æ”¶åˆ°æ¶ˆæ¯: Hello from main!`

#### é«˜çº§ç”¨æ³•ï¼šå¤šç”Ÿäº§è€…
```rust
let (tx, rx) = mpsc::channel();
let tx1 = tx.clone(); // å…‹éš†å‘é€ç«¯ï¼ˆå¤šç”Ÿäº§è€…ï¼‰

thread::spawn(move || {
    tx.send("Hi from thread 1").unwrap();
});

thread::spawn(move || {
    tx1.send("Hi from thread 2").unwrap();
});

// ä¸»çº¿ç¨‹æ¥æ”¶æ‰€æœ‰æ¶ˆæ¯
for msg in rx {
    println!("ä¸»æ¥æ”¶: {}", msg);
}
```
- **å…³é”®ç‰¹æ€§**ï¼š
  - **æ‰€æœ‰æƒè½¬ç§»**ï¼š`send()` ååŸå˜é‡å¤±æ•ˆï¼ˆå®‰å…¨ï¼ï¼‰
  - **è‡ªåŠ¨å…³é—­**ï¼šæ‰€æœ‰ `Sender` è¢«ä¸¢å¼ƒåï¼Œ`recv()` è¿”å› `Err`
  - **é˜»å¡/éé˜»å¡**ï¼š`recv()` é˜»å¡ï¼Œ`try_recv()` ç«‹å³è¿”å›

> ğŸ’¡ **ä¸ºä»€ä¹ˆæ¨èæ¶ˆæ¯ä¼ é€’ï¼Ÿ**  
> - æ— é”è®¾è®¡ï¼Œé¿å…æ­»é”  
> - æ•°æ®æ‰€æœ‰æƒæ¸…æ™°ï¼ˆæ¶ˆæ¯è¢«æ¶ˆè´¹åï¼Œå‘é€æ–¹ä¸èƒ½å†ç”¨ï¼‰  
> - æ›´ç¬¦åˆ Rust çš„æ‰€æœ‰æƒå“²å­¦

---

### å…­ã€å…¶ä»–å¿…å¤‡çŸ¥è¯†ç‚¹ï¼ˆä¸é—æ¼ï¼ï¼‰
#### 1. åŸå­ç±»å‹ï¼ˆ`std::sync::atomic`ï¼‰
- **åœºæ™¯**ï¼šç®€å•ç±»å‹ï¼ˆå¦‚è®¡æ•°å™¨ï¼‰æ— éœ€é”
- **åŸç†**ï¼šCPU çº§åŸå­æŒ‡ä»¤ï¼ˆæ¯” Mutex è½»é‡ï¼‰
```rust
use std::sync::atomic::{AtomicUsize, Ordering};
use std::thread;

fn main() {
    let counter = AtomicUsize::new(0);
    let mut handles = vec![];

    for _ in 0..10 {
        let counter = &counter;
        handles.push(thread::spawn(move || {
            counter.fetch_add(1, Ordering::Relaxed); // åŸå­æ“ä½œ
        }));
    }

    for h in handles {
        h.join().unwrap();
    }
    println!("è®¡æ•°: {}", counter.load(Ordering::Relaxed));
}
```
- **å…³é”®**ï¼š`Ordering` å‚æ•°ï¼ˆå†…å­˜é¡ºåºï¼‰ï¼Œåˆå­¦è€…ç”¨ `Relaxed` å³å¯

#### 2. çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆ`thread_local!`ï¼‰
- **åœºæ™¯**ï¼šæ¯ä¸ªçº¿ç¨‹éœ€è¦ç‹¬ç«‹å‰¯æœ¬ï¼ˆå¦‚å…¨å±€é…ç½®ï¼‰
```rust
thread_local! {
    static LOCAL_DATA: RefCell<i32> = RefCell::new(0);
}

fn main() {
    thread::spawn(|| {
        LOCAL_DATA.with(|data| {
            *data.borrow_mut() = 100;
            println!("çº¿ç¨‹1: {}", *data.borrow());
        });
    }).join().unwrap();

    LOCAL_DATA.with(|data| {
        println!("ä¸»çº¿ç¨‹: {}", *data.borrow()); // ä»æ˜¯0
    });
}
```
- **æ³¨æ„**ï¼šç”¨ `RefCell` å®ç°å†…éƒ¨å¯å˜æ€§

#### 3. çº¿ç¨‹ panic å¤„ç†
- å­çº¿ç¨‹ panic ä¸ä¼šç›´æ¥å¯¼è‡´ä¸»çº¿ç¨‹å´©æºƒ
- `join()` è¿”å› `Result`ï¼Œå¯æ•è·é”™è¯¯
```rust
let handle = thread::spawn(|| {
    panic!("å­çº¿ç¨‹ç‚¸äº†ï¼");
});

match handle.join() {
    Ok(_) => println!("æˆåŠŸ"),
    Err(e) => println!("å­çº¿ç¨‹é”™è¯¯: {:?}", e),
}
```

#### 4. é¿å…å¸¸è§é™·é˜±
| é™·é˜± | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| å¿˜è®° `join()` | æ€»æ˜¯ä¿å­˜ `JoinHandle` å¹¶è°ƒç”¨ `join()` |
| é”èŒƒå›´è¿‡å¤§ | åªé”å¿…è¦ä»£ç ï¼ˆ`let mut x = lock(); ...`ï¼‰ |
| åµŒå¥—é”é¡ºåºä¸ä¸€è‡´ | å›ºå®šé”é¡ºåºï¼ˆå¦‚å…ˆ A å Bï¼‰ |
| ç”¨ `Rc` ä»£æ›¿ `Arc` | å¤šçº¿ç¨‹å¿…é¡»ç”¨ `Arc` |

---

### ä¸ƒã€ç»ˆææ€»ç»“ï¼šRust å¤šçº¿ç¨‹å¿ƒæ³•
1. **ä¼˜å…ˆæ¶ˆæ¯ä¼ é€’**ï¼ˆ`mpsc`ï¼‰ï¼šå®‰å…¨ã€ç®€å•ã€æ— æ­»é”  
2. **å…±äº«çŠ¶æ€æ¬¡ä¹‹**ï¼š  
   - è¯»å¤šå†™å°‘ â†’ `RwLock` + `Arc`  
   - å‡è¡¡è¯»å†™ â†’ `Mutex` + `Arc`  
   - ç®€å•ç±»å‹ â†’ `Atomic`  
3. **ç¼–è¯‘å™¨æ˜¯ä½ çš„ç›Ÿå‹**ï¼š  
   - æ‰€æœ‰æƒè§„åˆ™åœ¨ç¼–è¯‘æœŸæ¶ˆç­æ•°æ®ç«äº‰  
   - é‡åˆ°é”™è¯¯åˆ«ç¡¬æ”¹ï¼Œç†è§£èƒŒåçš„å®‰å…¨é€»è¾‘  
4. **é»„é‡‘æ³•åˆ™**ï¼š  
   > "å¦‚æœæ•°æ®åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼Œç”¨ `move` è½¬ç§»æ‰€æœ‰æƒï¼›  
   > å¦‚æœå¤šçº¿ç¨‹éœ€è¦å…±äº«ï¼Œç”¨ `Arc` + åŒæ­¥åŸè¯­ã€‚"

---

### é™„ï¼šå®Œæ•´ç»ƒä¹ é¡¹ç›®ï¼ˆå·©å›ºæ‰€å­¦ï¼‰
```rust
// ä»»åŠ¡ï¼š5 ä¸ªç”Ÿäº§è€…ç”Ÿæˆéšæœºæ•°ï¼Œ1 ä¸ªæ¶ˆè´¹è€…æ±‚å’Œ
use std::sync::mpsc;
use std::thread;
use std::time::Duration;
use rand::Rng;

fn main() {
    let (tx, rx) = mpsc::channel();
    
    // å¯åŠ¨æ¶ˆè´¹è€…
    let consumer = thread::spawn(move || {
        let mut sum = 0;
        for num in rx {
            sum += num;
            println!("å½“å‰å’Œ: {}", sum);
            if sum > 100 { break; } // è¾¾åˆ°é˜ˆå€¼é€€å‡º
        }
        sum
    });

    // å¯åŠ¨5ä¸ªç”Ÿäº§è€…
    for i in 0..5 {
        let tx = tx.clone();
        thread::spawn(move || {
            let mut rng = rand::thread_rng();
            for _ in 0..10 {
                let num = rng.gen_range(1..=10);
                tx.send(num).unwrap();
                thread::sleep(Duration::from_millis(100));
            }
            println!("ç”Ÿäº§è€… {} å®Œæˆ", i);
        });
    }

    // ä¸»çº¿ç¨‹ç­‰å¾…ç»“æœ
    drop(tx); // å…³é—­å‘é€ç«¯ï¼Œå¦åˆ™æ¶ˆè´¹è€…ä¼šæ— é™ç­‰å¾…
    let total = consumer.join().unwrap();
    println!("æœ€ç»ˆæ€»å’Œ: {}", total);
}
```
> æ³¨ï¼šè¿è¡Œå‰è¯·å…ˆæ‰§è¡Œ `cargo add rand` æ·»åŠ ä¾èµ–
