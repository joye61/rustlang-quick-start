å½“ç„¶å¯ä»¥ï¼ä¸‹é¢æ˜¯ä¸€ä»½**æ›´è¯¦ç»†ã€é¢å‘ç†è§£å½»åº•**çš„æ•™ç¨‹ï¼Œå…¨é¢è®²è§£ Rust ä¸­çš„ï¼š

* `Sized` trait
* åŠ¨æ€å¤§å°ç±»å‹ï¼ˆDSTï¼‰
* ä¸ºä»€ä¹ˆéœ€è¦ `?Sized`
* èƒ–æŒ‡é’ˆä¸å†…å­˜å¸ƒå±€
* åœ¨æ³›å‹ã€Traitã€Boxã€å‡½æ•°å‚æ•°ä¸­å¦‚ä½•æ­£ç¡®ä½¿ç”¨å®ƒä»¬

ğŸ“Œ æœ¬æ–‡ä¸º Rust ä¸­é«˜çº§ç±»å‹ç³»ç»Ÿçš„æ ¸å¿ƒå†…å®¹ï¼Œé…åˆå¤§é‡å›¾è§£å¼è®²è§£æ€ç»´å’Œç¤ºä¾‹ä»£ç ï¼Œè®©ä½ çœŸæ­£å½»åº•ææ‡‚è¿™å—å†…å®¹ã€‚

---

# ğŸ§  å…¨é¢è¯¦è§£ Rust çš„ `Sized` å’Œ ä¸å®šé•¿ç±»å‹ï¼ˆDSTï¼‰

---

## ä¸€ã€ä»€ä¹ˆæ˜¯ `Sized`ï¼Ÿ

åœ¨ Rust ä¸­ï¼Œæ¯ä¸ªç±»å‹çš„å¤§å°ï¼ˆsizeï¼‰å¿…é¡»**åœ¨ç¼–è¯‘æ—¶ç¡®å®š**ï¼Œè¿™æ ·ç¼–è¯‘å™¨æ‰èƒ½ä¸ºå…¶åˆ†é…å†…å­˜ã€‚

è¿™ç±»â€œå¤§å°å·²çŸ¥â€çš„ç±»å‹ï¼Œè¢«ç§°ä¸º `Sized` ç±»å‹ã€‚

### Rust ä¸­æ‰€æœ‰ç±»å‹é»˜è®¤éƒ½å®ç°äº† `Sized`

```rust
let x: i32 = 5;
let y: (u8, bool) = (1, true);
```

è¿™äº›éƒ½æ˜¯é™æ€å¤§å°ç±»å‹ï¼Œå¤§å°å·²çŸ¥ â†’ é»˜è®¤æ»¡è¶³ `Sized` traitã€‚

---

## äºŒã€ä»€ä¹ˆæ˜¯ `!Sized`ï¼ˆä¸å®šé•¿ç±»å‹ / DSTï¼‰ï¼Ÿ

### ğŸ”¥ æœ‰äº›ç±»å‹çš„å¤§å°ä¸èƒ½åœ¨ç¼–è¯‘æ—¶ç¡®å®šï¼Œæ¯”å¦‚ï¼š

* `[T]`ï¼šä¸€ä¸ªåˆ‡ç‰‡ï¼ˆå¦‚ `[1, 2, 3]`ï¼‰
* `str`ï¼šä¸€ä¸ª UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²åˆ‡ç‰‡
* `dyn Trait`ï¼šTrait å¯¹è±¡ï¼ˆä¾‹å¦‚ `dyn Display`ï¼‰

è¿™äº›ç±»å‹åœ¨ç¼–è¯‘æ—¶**ä¸çŸ¥é“å¤§å°æ˜¯å¤šå°‘**ï¼Œæ— æ³•è¢«ç›´æ¥åˆ†é…åˆ°æ ˆä¸Šã€‚

å®ƒä»¬è¢«ç§°ä¸ºï¼š

> **DSTï¼šDynamically Sized Typesï¼ˆåŠ¨æ€å¤§å°ç±»å‹ï¼‰**

---

## ä¸‰ã€`Sized` æ˜¯ä¸€ä¸ªç‰¹æ®Š traitï¼ˆè‡ªåŠ¨å®ç°ï¼‰

å®ƒå®šä¹‰åœ¨æ ‡å‡†åº“ä¸­ï¼Œé•¿è¿™æ ·ï¼š

```rust
#[lang = "sized"]
pub trait Sized {}
```

* å¤§éƒ¨åˆ†ç±»å‹é»˜è®¤å°±æ˜¯ `Sized`
* ç¼–è¯‘å™¨ä¼šä¸ºæ¯ä¸ªç±»å‹è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦æ˜¯ `Sized`

---

## å››ã€æ³›å‹ä¸­çš„ `Sized` é™åˆ¶ï¼ˆé»˜è®¤çº¦æŸï¼‰

```rust
fn print<T>(value: T) {
    // é»˜è®¤ç­‰ä»·äºï¼šfn print<T: Sized>(value: T)
}
```

Rust ä¼šè‡ªåŠ¨ç»™æ³›å‹å‡½æ•°åŠ ä¸Š `T: Sized` é™åˆ¶ â€”â€” ä¹Ÿå°±æ˜¯è¯´ï¼Œé»˜è®¤**åªæ¥å—å¤§å°å·²çŸ¥çš„ç±»å‹**ã€‚

---

## äº”ã€æƒ³è¦æ”¯æŒ DSTï¼Ÿä½¿ç”¨ `T: ?Sized`

`?Sized` è¡¨ç¤ºï¼š

> è¿™ä¸ªç±»å‹ **å¯èƒ½ä¸æ˜¯ `Sized`**ï¼Œä¹Ÿå¯èƒ½æ˜¯ï¼

```rust
fn print_value<T: ?Sized>(val: &T) {
    // val å¿…é¡»æ˜¯å¼•ç”¨ï¼Œæ‰èƒ½ä¼ å…¥ DST
    println!("Address: {:p}", val);
}
```

### âœ… æ­£ç¡®è°ƒç”¨ï¼š

```rust
print_value(&"hello");         // str â†’ DST â†’ OK
print_value(&[1, 2, 3]);       // [i32] â†’ DST â†’ OK
print_value(&123);            // i32 â†’ Sized â†’ OK
```

---

## å…­ã€å¸¸è§ DST ç±»å‹æœ‰å“ªäº›ï¼Ÿ

| ç±»å‹          | æ˜¯å¦ DST | æ˜¯å¦èƒ½ç›´æ¥ç”¨ï¼Ÿ | æ­£ç¡®ç”¨æ³•                           |
| ----------- | ------ | ------- | ------------------------------ |
| `i32`ã€`f64` | âŒ      | âœ…       | `let x: i32 = 1;`              |
| `[T]`ï¼ˆåˆ‡ç‰‡ï¼‰   | âœ…      | âŒä¸èƒ½ç›´æ¥ç”¨  | `&[T]`, `Box<[T]>`             |
| `str`       | âœ…      | âŒä¸èƒ½ç›´æ¥ç”¨  | `&str`, `Box<str>`             |
| `dyn Trait` | âœ…      | âŒä¸èƒ½ç›´æ¥ç”¨  | `&dyn Trait`, `Box<dyn Trait>` |

### âŒ é”™è¯¯ç¤ºä¾‹ï¼š

```rust
let s: str = "hello".to_string();  // âŒ ç¼–è¯‘å¤±è´¥ï¼šstr æ˜¯ DSTï¼Œä¸èƒ½ç›´æ¥ç”¨
```

---

## ä¸ƒã€èƒ–æŒ‡é’ˆï¼ˆFat Pointerï¼‰

DST **ä¸èƒ½ç›´æ¥ä½¿ç”¨**ï¼Œä½†ä½ å¯ä»¥ç”¨å¼•ç”¨æˆ– `Box` æ¥åŒ…è£¹å®ƒä»¬ã€‚

è¿™æ—¶ Rust ç”¨çš„æ˜¯ï¼š

> **èƒ–æŒ‡é’ˆï¼ˆFat Pointerï¼‰**

èƒ–æŒ‡é’ˆ = æ™®é€šæŒ‡é’ˆ + å…ƒæ•°æ®

| DST ç±»å‹       | èƒ–æŒ‡é’ˆå†…å®¹           |
| ------------ | --------------- |
| `&[T]`       | æŒ‡é’ˆ + é•¿åº¦         |
| `&str`       | æŒ‡é’ˆ + å­—èŠ‚æ•°        |
| `&dyn Trait` | æŒ‡é’ˆ + vtableï¼ˆè™šè¡¨ï¼‰ |

```rust
fn show_info(slice: &[i32]) {
    println!("Address: {:p}, Length: {}", slice.as_ptr(), slice.len());
}
```

èƒ–æŒ‡é’ˆå…¶å®æ˜¯ä¸€ç§å¤šå­—æ®µç»“æ„ï¼Œå†…éƒ¨éšè—ç®¡ç†å…ƒä¿¡æ¯ã€‚

---

## å…«ã€å¦‚ä½•ä½¿ç”¨ DSTï¼Ÿ

### âœ… ä½¿ç”¨å¼•ç”¨

```rust
fn print_str(s: &str) {
    println!("{}", s);
}
```

ä½ ä¸èƒ½æ‹¥æœ‰ `str`ï¼Œä½†å¯ä»¥æ‹¥æœ‰ `&str`ã€‚

---

### âœ… ä½¿ç”¨ `Box<T>` å­˜å‚¨ DST

`Box<T>` æ”¯æŒå †ä¸Šåˆ†é… DSTã€‚

```rust
fn main() {
    let boxed_str: Box<str> = "hello".to_owned().into_boxed_str();
    let boxed_slice: Box<[i32]> = vec![1, 2, 3].into_boxed_slice();
}
```

---

### âœ… ä½¿ç”¨ Trait å¯¹è±¡ï¼ˆ`dyn Trait`ï¼‰

```rust
use std::fmt::Display;

fn print_display(x: &dyn Display) {
    println!("{}", x);
}
```

* `dyn Display` æ˜¯ DST
* `&dyn Display` æ˜¯èƒ–æŒ‡é’ˆ

---

## ä¹ã€ä½ ä¸èƒ½åˆ›å»º DST çš„â€œå€¼â€ï¼Œåªèƒ½é€šè¿‡å¼•ç”¨/Box

```rust
fn main() {
    let x: str = *"hello"; // âŒ é”™è¯¯ï¼šstr æ˜¯ DSTï¼Œä¸èƒ½è¿™æ ·ç”¨
}
```

è§£å†³æ–¹æ¡ˆï¼š

```rust
let x: &str = "hello"; // âœ… æ­£ç¡®ï¼šç”¨èƒ–æŒ‡é’ˆå­˜å‚¨ DST
```

---

## ğŸ”Ÿ æ³›å‹ä¸­ç”¨ `?Sized` çš„å®Œæ•´ç¤ºä¾‹

```rust
use std::fmt::Debug;

// æ”¯æŒ DST çš„é€šç”¨æ‰“å°å‡½æ•°
fn debug_print<T: ?Sized + Debug>(val: &T) {
    println!("{:?}", val);
}

fn main() {
    let s = "hello";
    let arr = [1, 2, 3];
    debug_print(&s);     // &str
    debug_print(&arr);   // &[i32]
    debug_print(&123);   // &i32
}
```

---

## ğŸ§  æ€»ç»“ï¼šä¸ºä»€ä¹ˆ `Sized` å’Œ `?Sized` é‡è¦ï¼Ÿ

| ä½ æƒ³åšçš„äº‹       | æ˜¯å¦éœ€è¦æ³¨æ„ `Sized`ï¼Ÿ | è¯´æ˜                            |
| ----------- | --------------- | ----------------------------- |
| å®šä¹‰æ³›å‹å‡½æ•°      | é»˜è®¤æœ‰ `T: Sized`  | è‹¥è¦æ”¯æŒ DSTï¼Œå¿…é¡»å†™ `T: ?Sized`      |
| æ¥æ”¶å­—ç¬¦ä¸²æˆ–åˆ‡ç‰‡å‚æ•°  | âœ…               | åªèƒ½ç”¨ `&str` æˆ– `&[T]`ï¼ˆèƒ–æŒ‡é’ˆï¼‰      |
| å­˜å‚¨ DST      | âœ…               | ç”¨ `Box<T>`ã€`&T`ã€`Rc<T>` ç­‰åŒ…è£¹æ–¹å¼ |
| å®šä¹‰ trait å¯¹è±¡ | âœ…               | ä½¿ç”¨ `dyn Trait`ï¼Œå¹¶é€šè¿‡èƒ–æŒ‡é’ˆè®¿é—®       |
| æ„é€ å¤æ‚æ•°æ®ç»“æ„    | âœ…               | æŸäº›å­—æ®µå¯èƒ½æ˜¯ DSTï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†            |

---

# ä¸ºä»€ä¹ˆ DST ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Ÿ


## â€œå¼•ç”¨â€çš„æœ¬è´¨

åœ¨ Rust ä¸­ï¼Œ**å¼•ç”¨**ï¼ˆ`&T`ï¼‰æ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹ï¼ŒæŒ‡å‘æŸä¸ªå€¼åœ¨å†…å­˜ä¸­çš„ä½ç½®ã€‚

```rust
let x = 10;
let r = &x;
```

æ­¤æ—¶ï¼š

* `x` æ˜¯å€¼ï¼ˆi32ï¼Œå¤§å°å·²çŸ¥ï¼‰
* `r` æ˜¯å¼•ç”¨ï¼ŒæŒ‡å‘ `x`ï¼Œå ç”¨ 8 å­—èŠ‚ï¼ˆ64 ä½ç³»ç»Ÿï¼‰

### âœ… æœ¬è´¨ï¼šå¼•ç”¨æ˜¯ä¸ª**æŒ‡é’ˆ**ï¼Œä½†åŠ äº† Rust çš„æ‰€æœ‰æƒå’Œå€Ÿç”¨è§„åˆ™

| ç±»å‹       | å®é™…å«ä¹‰       |
| -------- | ---------- |
| `&T`     | æŒ‡é’ˆï¼ŒæŒ‡å‘ç±»å‹ T  |
| `&mut T` | å¯å˜æŒ‡é’ˆ       |
| `Box<T>` | å †ä¸ŠæŒ‡é’ˆï¼ˆæ™ºèƒ½æŒ‡é’ˆï¼‰ |

---

## ä¸ºä»€ä¹ˆ DSTï¼ˆåŠ¨æ€å¤§å°ç±»å‹ï¼‰ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Ÿ

### â“ä»€ä¹ˆæ˜¯ DSTï¼ˆåŠ¨æ€å¤§å°ç±»å‹ï¼‰ï¼Ÿ

åŠ¨æ€å¤§å°ç±»å‹ï¼ˆDSTï¼‰æ˜¯ï¼š**åœ¨ç¼–è¯‘æ—¶æ— æ³•ç¡®å®šå¤§å°çš„ç±»å‹**ã€‚

ä¾‹å¦‚ï¼š

```rust
str      // å­—ç¬¦ä¸²åˆ‡ç‰‡ï¼ˆé•¿åº¦ä¸å›ºå®šï¼‰
[T]      // æ•°ç»„åˆ‡ç‰‡ï¼ˆå¦‚ [i32]ï¼‰
dyn Trait // Trait å¯¹è±¡ï¼ˆå®é™…ç±»å‹æœªçŸ¥ï¼‰
```

### âŒ ç¼–è¯‘å™¨æ‹’ç»è¿™æ ·å†™ï¼š

```rust
let s: str = *"hello";   // âŒ é”™è¯¯ï¼š`str` å¤§å°æœªçŸ¥
let arr: [i32] = [1, 2, 3]; // âŒ ç¼–è¯‘ä¸é€šè¿‡
```

### âœ… åŸå› ï¼š**æ ˆå†…å­˜éœ€è¦çŸ¥é“å¤§å°**

Rust ä¸­æ‰€æœ‰å˜é‡éƒ½é»˜è®¤å­˜åœ¨**æ ˆ**ä¸Šï¼Œè€Œæ ˆæ˜¯ä¸¥æ ¼æŒ‰å¤§å°å¯¹é½çš„çº¿æ€§å†…å­˜å—ã€‚

> ä½ è¦æ”¾ä¸ªå˜é‡åˆ°æ ˆä¸Šï¼Œç¼–è¯‘å™¨å°±å¿…é¡»çŸ¥é“ï¼šâ€œè¿™ä¸ªå˜é‡åˆ°åº•å å‡ ä¸ªå­—èŠ‚ï¼Ÿâ€

å¦‚æœä½ è¯´ï¼šæˆ‘è¦æ”¾ä¸€ä¸ª `str` ç±»å‹çš„å€¼ï¼Œä½†æ²¡æœ‰å‘Šè¯‰æˆ‘å®ƒå¤šé•¿ï¼ˆå‡ å­—èŠ‚ï¼‰ï¼Œé‚£æˆ‘ç¼–è¯‘å™¨å°±æ²¡æ³•å®‰æ’ç©ºé—´ï¼Œä¹Ÿæ²¡æ³•ç”Ÿæˆä»£ç ã€‚

---

# ğŸ§© ä¸‰ã€ä½†ä¸ºä»€ä¹ˆé€šè¿‡å¼•ç”¨å°±å¯ä»¥ä½¿ç”¨ DSTï¼Ÿ

å› ä¸ºï¼š

> **å¼•ç”¨æ˜¯å›ºå®šå¤§å°çš„æŒ‡é’ˆ**ï¼Œè€Œ DST çš„â€œå®é™…å¤§å°â€ä¿¡æ¯å¯ä»¥é€šè¿‡**èƒ–æŒ‡é’ˆ**å­˜å‚¨ã€‚

---

## ğŸ” å››ã€èƒ–æŒ‡é’ˆï¼ˆfat pointerï¼‰ï¼šè®© DST â€œå¸¦å‚æ•°â€ä½¿ç”¨

å¯¹äº DST ç±»å‹ï¼ŒRust ä¸æ˜¯ç®€å•ç»™ä¸€ä¸ªåœ°å€ï¼Œè€Œæ˜¯ç»™**å¤šä¸ªä¿¡æ¯**ç»„æˆçš„â€œèƒ–æŒ‡é’ˆâ€ï¼š

### âœ… èƒ–æŒ‡é’ˆçš„ç»“æ„ï¼š

| DST ç±»å‹       | èƒ–æŒ‡é’ˆå†…å®¹               |
| ------------ | ------------------- |
| `&[T]`       | æŒ‡é’ˆ + é•¿åº¦ï¼ˆå¤šå°‘ä¸ª Tï¼‰      |
| `&str`       | æŒ‡é’ˆ + å­—èŠ‚æ•°            |
| `&dyn Trait` | æŒ‡é’ˆ + è™šå‡½æ•°è¡¨æŒ‡é’ˆï¼ˆvtableï¼‰ |

### âœ… ä¸¾ä¾‹ï¼š`&str` å®é™…ç»“æ„

```rust
let s: &str = "hello";
```

* `s` æ˜¯èƒ–æŒ‡é’ˆï¼Œå ä¸¤ä¸ª `usize`ï¼ˆ64 ä½ä¸‹æ˜¯ 16 å­—èŠ‚ï¼‰
* ç¬¬ä¸€ä¸ª `usize`ï¼šæŒ‡å‘ `h`
* ç¬¬äºŒä¸ª `usize`ï¼šé•¿åº¦ = 5ï¼ˆ"hello" æœ‰ 5 ä¸ªå­—èŠ‚ï¼‰

### âœ… ä¸¾ä¾‹ï¼š`&dyn Display`

```rust
use std::fmt::Display;

let num: i32 = 42;
let d: &dyn Display = &num;
```

* `d` æ˜¯èƒ–æŒ‡é’ˆ

  * ç¬¬ä¸€ä¸ªéƒ¨åˆ†ï¼šæŒ‡å‘ `num`
  * ç¬¬äºŒéƒ¨åˆ†ï¼šæŒ‡å‘ `vtable`ï¼Œå³è™šå‡½æ•°è¡¨ï¼ŒåŒ…å«äº†ï¼š

    * `Display::fmt`
    * `Drop`
    * `Any` ç­‰æ–¹æ³•çš„å‡½æ•°åœ°å€

---

# ğŸ§ª äº”ã€ä»£ç å®è¯

### âŒ é”™è¯¯ç¤ºä¾‹ï¼šDST ä¸èƒ½ç›´æ¥ç”¨

```rust
fn main() {
    let s: str = *"hello"; // âŒ error: the size for values of type `str` cannot be known at compilation time
}
```

### âœ… æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨å¼•ç”¨ï¼ˆèƒ–æŒ‡é’ˆï¼‰

```rust
fn main() {
    let s: &str = "hello";       // &str æ˜¯èƒ–æŒ‡é’ˆ
    let arr: &[i32] = &[1, 2, 3]; // &[i32] æ˜¯èƒ–æŒ‡é’ˆ
    println!("{}", s);
    println!("{:?}", arr);
}
```

---

# ğŸ§¬ å…­ã€DST çš„ä½¿ç”¨åœºæ™¯æ€»ç»“

| ä½ æƒ³ç”¨çš„ DST ç±»å‹ | æ­£ç¡®æ–¹å¼                            | è¯´æ˜          |
| ----------- | ------------------------------- | ----------- |
| `str`       | `&str` / `Box<str>`             | é€šè¿‡å¼•ç”¨æˆ–å †åˆ†é…    |
| `[T]`       | `&[T]` / `Box<[T]>`             | ä¸èƒ½ç›´æ¥å†™ `[T]` |
| `dyn Trait` | `&dyn Trait` / `Box<dyn Trait>` | Trait å¯¹è±¡    |

---

# ğŸ§  ä¸ƒã€å®Œæ•´ç†è§£æµç¨‹å°æ€»ç»“

1. Rust æ˜¯é™æ€å†…å­˜å®‰å…¨è¯­è¨€
2. ç¼–è¯‘æ—¶å¿…é¡»çŸ¥é“å˜é‡å¤§å°ï¼Œæ‰èƒ½å®‰æ’å†…å­˜ï¼ˆæ ˆï¼‰
3. DST æ²¡æœ‰å›ºå®šå¤§å°ï¼Œä¸èƒ½æ”¾æ ˆ
4. ä½†å¼•ç”¨æ˜¯å›ºå®šå¤§å°çš„æŒ‡é’ˆï¼ˆæˆ–èƒ–æŒ‡é’ˆï¼‰ï¼Œå¯ä»¥åœ¨ç¼–è¯‘æ—¶ä½¿ç”¨
5. æ‰€ä»¥ DST **åªèƒ½é€šè¿‡å¼•ç”¨æˆ– Box ç­‰æŒ‡é’ˆç±»å‹ä½¿ç”¨**

---
