å¥½çš„ï¼ä»¥ä¸‹æ˜¯å…³äº **Rust è¯­è¨€çš„ç±»å‹è½¬æ¢ã€newtype æ¨¡å¼ä¸ç±»å‹åˆ«å** çš„å®Œæ•´é€šä¿—æ•™ç¨‹ï¼Œè¦†ç›–æ‰€æœ‰ä¸»è¦è¯­æ³•ä¸çŸ¥è¯†ç‚¹ï¼Œå¹¶é…æœ‰è¯¦ç»†ç¤ºä¾‹å’Œæ€»ç»“ã€‚

---

# ğŸŒŸ Rust ç±»å‹ç³»ç»Ÿè¿›é˜¶æ•™ç¨‹ï¼šç±»å‹è½¬æ¢ã€Newtype å’Œç±»å‹åˆ«åè¯¦è§£

Rust æ˜¯ä¸€é—¨**å¼ºç±»å‹è¯­è¨€**ï¼Œç±»å‹å®‰å…¨æ˜¯å®ƒçš„ä¸€å¤§æ ¸å¿ƒè®¾è®¡å“²å­¦ã€‚è™½ç„¶ Rust å¾ˆä¸¥æ ¼ï¼Œä½†å®ƒä¹Ÿæä¾›äº†å¤šç§æ–¹å¼è®©æˆ‘ä»¬åœ¨ä¸åŒç±»å‹ä¹‹é—´è¿›è¡Œå®‰å…¨ã€é«˜æ•ˆçš„è½¬æ¢ï¼Œæˆ–è€…ä¸ºå·²æœ‰ç±»å‹åˆ›å»ºæ›´è¯­ä¹‰æ¸…æ™°çš„æ–°åç§°ã€‚

æœ¬æ•™ç¨‹å°†è¯¦ç»†ä»‹ç» Rust ä¸­çš„ä¸‰ç§ç›¸å…³å†…å®¹ï¼š

1. ç±»å‹è½¬æ¢ï¼ˆType Conversionï¼‰
2. Newtype æ¨¡å¼ï¼ˆNewtype Patternï¼‰
3. ç±»å‹åˆ«åï¼ˆType Aliasï¼‰

---

## ğŸ§± ä¸€ã€ç±»å‹è½¬æ¢ï¼ˆType Conversionï¼‰

Rust é»˜è®¤ä¸è¿›è¡Œ**éšå¼ç±»å‹è½¬æ¢ï¼ˆimplicit coercionï¼‰**ï¼Œä¸åƒ C/C++ å¯ä»¥è‡ªåŠ¨æŠŠ `int` è½¬æˆ `float`ï¼ŒRust ä¸€åˆ‡éƒ½å¿…é¡»**æ˜¾å¼è½¬æ¢**ã€‚

### 1.1 åŸºæœ¬æ•°å€¼ç±»å‹ä¹‹é—´çš„è½¬æ¢

#### ä½¿ç”¨ `as` å…³é”®å­—

```rust
fn main() {
    let x: u32 = 10;
    let y: f64 = x as f64;
    println!("y = {}", y); // y = 10.0
}
```

`as` ä¼š**å¼ºåˆ¶è½¬æ¢**ï¼Œä½†è¯·å°å¿ƒç²¾åº¦æŸå¤±æˆ–æº¢å‡ºã€‚

```rust
fn main() {
    let a: i32 = -1;
    let b: u32 = a as u32; // b = 4294967295
    println!("b = {}", b);
}
```

### 1.2 å­—ç¬¦å’Œæ•°å­—ä¹‹é—´çš„è½¬æ¢

```rust
fn main() {
    let c = 'A';
    let code = c as u8;
    println!("ASCII: {}", code); // ASCII: 65
}
```

```rust
fn main() {
    let code = 66;
    let c = char::from_u32(code).unwrap();
    println!("Char: {}", c); // Char: B
}
```

### 1.3 ä½¿ç”¨ `TryFrom` å’Œ `TryInto`

å¯¹äºå¯èƒ½å¤±è´¥çš„è½¬æ¢ï¼ˆæ¯”å¦‚è´Ÿæ•°è½¬æ— ç¬¦å·ï¼‰ï¼Œåº”ä½¿ç”¨ `std::convert::TryFrom`ã€‚

```rust
use std::convert::TryFrom;

fn main() {
    let n: i16 = -10;
    let result = u16::try_from(n);
    match result {
        Ok(v) => println!("v = {}", v),
        Err(e) => println!("Error: {}", e),
    }
}
```

### 1.4 è‡ªå®šä¹‰ç±»å‹è½¬æ¢ï¼š`From` å’Œ `Into`

#### å®ç° `From`

```rust
struct MyNumber(i32);

impl From<i32> for MyNumber {
    fn from(num: i32) -> Self {
        MyNumber(num)
    }
}

fn main() {
    let my_num = MyNumber::from(100);
}
```

#### è‡ªåŠ¨è¡ç”Ÿ `Into`

åªè¦å®ç°äº† `From<T> for U`ï¼Œå°±å¯ä»¥è‡ªåŠ¨ä½¿ç”¨ `Into<U> for T`

```rust
fn main() {
    let n: MyNumber = 200.into(); // è‡ªåŠ¨è½¬æ¢
}
```

### 1.5 ä½¿ç”¨ `as` vs `From/Into`

| åœºæ™¯     | æ¨èç”¨æ³•        | æ˜¯å¦å®‰å…¨  |
| ------ | ----------- | ----- |
| åŸºç¡€ç±»å‹å¼ºè½¬ | `as`        | ä¸ä¸€å®šå®‰å…¨ |
| è‡ªå®šä¹‰ç±»å‹  | `From/Into` | å®‰å…¨    |
| å¯èƒ½å¤±è´¥   | `TryFrom`   | å®‰å…¨    |

---

## ğŸ§³ äºŒã€Newtype æ¨¡å¼ï¼ˆNewtype Patternï¼‰

Newtype æ˜¯ä¸€ç§ä¸ºç°æœ‰ç±»å‹åˆ›å»ºâ€œåŒ…è£¹â€çš„æ–°ç±»å‹ï¼Œä»¥æ·»åŠ è¯­ä¹‰æˆ–å®ç° Traitã€‚

### 2.1 ä»€ä¹ˆæ˜¯ Newtypeï¼Ÿ

```rust
struct Meters(u32); // åŒ…è£¹äº†ä¸€ä¸ª u32

fn main() {
    let distance = Meters(100);
}
```

ç›¸æ¯”ç›´æ¥ä½¿ç”¨ `u32`ï¼Œ`Meters` æ›´å…·è¯­ä¹‰ï¼Œä¹Ÿé¿å…äº†ç±»å‹æ··æ·†ï¼š

```rust
struct Seconds(u32);

fn run(distance: Meters, time: Seconds) {
    println!("Speed: {} m/s", distance.0 / time.0);
}
```

### 2.2 ä¸ºä»€ä¹ˆä½¿ç”¨ Newtypeï¼Ÿ

* å¢åŠ è¯­ä¹‰ï¼ˆå•ä½ã€ä½œç”¨æ˜ç¡®ï¼‰
* é˜²æ­¢ç±»å‹è¯¯ç”¨
* å¯ä»¥ä¸ºå…¶å•ç‹¬å®ç° Traitï¼ˆæ¯”å¦‚ `Display`, `Add` ç­‰ï¼‰

```rust
use std::fmt;

struct UserId(u64);

impl fmt::Display for UserId {
    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {
        write!(f, "#{}", self.0)
    }
}
```

### 2.3 è®¿é—®å†…éƒ¨å€¼

```rust
let id = UserId(42);
println!("id = {}", id.0);
```

ä½ ä¹Ÿå¯ä»¥å®ç°ä¸€ä¸ªæ–¹æ³•æ¥å°è£…è®¿é—®é€»è¾‘ï¼š

```rust
impl UserId {
    fn value(&self) -> u64 {
        self.0
    }
}
```

### 2.4 ä¸å…ƒç»„ç±»å‹çš„åŒºåˆ«ï¼Ÿ

```rust
struct Newtype(u32);    // å®šä¹‰äº†ä¸€ä¸ªæ–°ç±»å‹
type Alias = (u32);     // åªæ˜¯åˆ«åï¼Œä¸æ˜¯æ–°ç±»å‹
```

---

## ğŸªª ä¸‰ã€ç±»å‹åˆ«åï¼ˆType Aliasï¼‰

ç±»å‹åˆ«åç”¨ `type` å…³é”®å­—ä¸ºå·²æœ‰ç±»å‹èµ·ä¸€ä¸ªæ–°åå­—ï¼Œä¸åˆ›å»ºæ–°ç±»å‹ã€‚

### 3.1 åŸºæœ¬ç”¨æ³•

```rust
type Kilometers = i32;

fn distance(d: Kilometers) {
    println!("Distance = {}", d);
}
```

æœ¬è´¨ä¸Šï¼Œ`Kilometers` è¿˜æ˜¯ `i32`ï¼Œä¸èƒ½ç”¨äºç±»å‹åŒºåˆ†ã€‚

### 3.2 ç”¨äºç®€åŒ–å¤æ‚ç±»å‹

```rust
use std::collections::HashMap;

type Name = String;
type Scores = HashMap<Name, Vec<u32>>;

fn main() {
    let mut scores: Scores = HashMap::new();
}
```

### 3.3 ä¸ Newtype çš„åŒºåˆ«

| ç‰¹æ€§       | ç±»å‹åˆ«åï¼ˆAliasï¼‰ | Newtype   |
| -------- | ----------- | --------- |
| æ˜¯å¦åˆ›å»ºæ–°ç±»å‹  | âŒ å¦         | âœ… æ˜¯       |
| ç±»å‹å®‰å…¨     | âŒ æ—          | âœ… æœ‰       |
| Trait å®ç° | å…±äº«åŸå§‹ç±»å‹      | å¯å•ç‹¬å®ç°     |
| ç”¨é€”       | ç®€åŒ–ä»£ç ã€å¯è¯»æ€§    | å¢å¼ºè¯­ä¹‰ã€ç±»å‹éš”ç¦» |

---

## ğŸ§  æ€»ç»“

| æ¦‚å¿µ       | å…³é”®ç‚¹æ€»ç»“          |
| -------- | -------------- |
| **ç±»å‹è½¬æ¢** | - Rust ä¸å…è®¸éšå¼è½¬æ¢ |

* ç”¨ `as` åšåŸºç¡€ç±»å‹è½¬æ¢
* ç”¨ `From/Into` åšå®‰å…¨è½¬æ¢
* ç”¨ `TryFrom` åšå¤±è´¥å¯å¤„ç†è½¬æ¢ |
  \| **Newtype**  | - ä¸ºå·²æœ‰ç±»å‹åŒ…è£…æ–°ç±»å‹
* å¢å¼ºè¯­ä¹‰ + ç±»å‹å®‰å…¨
* å¯ä¸ºå…¶å•ç‹¬å®ç° Trait |
  \| **ç±»å‹åˆ«å** | - ä¸æ”¹å˜åŸå§‹ç±»å‹
* ç”¨äºç®€åŒ–é•¿æˆ–å¤æ‚çš„ç±»å‹ç­¾å
* ä¸å…·å¤‡ç±»å‹éš”ç¦»èƒ½åŠ› |

---

## âœ… å»ºè®®ä½¿ç”¨åœºæ™¯

| ç›®çš„          | æ¨èæ–¹å¼              |
| ----------- | ----------------- |
| æƒ³è¦åŒºåˆ†å•ä½æˆ–é˜²æ­¢æ··æ·† | Newtype           |
| åªæ˜¯ä¸ºäº†è®©ä»£ç æ›´æ¸…æ™°  | ç±»å‹åˆ«å              |
| ç±»å‹ä¹‹é—´éœ€è¦å®‰å…¨è½¬æ¢  | From/Into/TryFrom |
| å¿«é€Ÿå¼ºè½¬ä½†æ‰¿æ‹…é£é™©   | as                |

---


# `From`ã€`Into`ã€`TryFrom`ã€`TryInto`

Rust æ˜¯å¼ºç±»å‹è¯­è¨€ï¼Œä¸å…è®¸éšå¼ç±»å‹è½¬æ¢ã€‚ä½†å®ƒæä¾›äº†å››ä¸ª Traitï¼Œå¸®åŠ©ä½ åœ¨ç±»å‹ä¹‹é—´**å®‰å…¨ã€æ¸…æ™°ã€å¯æ§**åœ°è¿›è¡Œè½¬æ¢ï¼š

| Trait        | æ˜¯å¦å¯èƒ½å¤±è´¥  | å¸¸ç”¨äºä»€ä¹ˆåœºæ™¯    |
| ------------ | ------- | ---------- |
| `From<T>`    | âœ… æ°¸ä¸å¤±è´¥  | æ˜ç¡®èƒ½å®‰å…¨è½¬æ¢    |
| `Into<T>`    | âœ… æ°¸ä¸å¤±è´¥  | é€‚é…æ€§å¼ºï¼Œé…åˆæ³›å‹  |
| `TryFrom<T>` | âš ï¸ å¯èƒ½å¤±è´¥ | ç±»å‹ä¸ä¸€å®šèƒ½å®‰å…¨è½¬æ¢ |
| `TryInto<T>` | âš ï¸ å¯èƒ½å¤±è´¥ | åŒä¸Šï¼Œé€‚ç”¨äºæ³›å‹å‡½æ•° |

---

## âœ¨ ä¸€ã€From Trait

### âœ… å®šä¹‰ï¼š

`From<T>` è¡¨ç¤ºå¯ä»¥ä»ç±»å‹ `T` **è½¬æ¢ä¸º Self ç±»å‹**ï¼Œè€Œä¸”è¿™ä¸ªè½¬æ¢**æ°¸è¿œä¸ä¼šå¤±è´¥**ã€‚

```rust
pub trait From<T> {
    fn from(value: T) -> Self;
}
```

### âœ… ç¤ºä¾‹ 1ï¼šåŸºæœ¬ç±»å‹è½¬æ¢

```rust
fn main() {
    let s = String::from("hello"); // ä» &str è½¬æ¢æˆ String
}
```

Rust æ ‡å‡†åº“ä¸ºå¸¸è§ç±»å‹å®ç°äº† `From`ï¼Œæ¯”å¦‚ï¼š

```rust
impl From<&str> for String
```

### âœ… ç¤ºä¾‹ 2ï¼šè‡ªå®šä¹‰ç»“æ„ä½“è½¬æ¢

```rust
struct MyInt(i32);

impl From<i32> for MyInt {
    fn from(num: i32) -> Self {
        MyInt(num)
    }
}

fn main() {
    let a = MyInt::from(5);
    println!("a = {}", a.0); // è¾“å‡º: 5
}
```

---

## ğŸ”„ äºŒã€Into Trait

### âœ… å®šä¹‰ï¼š

`Into<T>` è¡¨ç¤ºå¯ä»¥**è½¬æ¢ä¸ºç±»å‹ T**ï¼Œå‰ææ˜¯ `T` å®ç°äº† `From<Self>`ã€‚

```rust
pub trait Into<T> {
    fn into(self) -> T;
}
```

ä½ **é€šå¸¸ä¸ç”¨è‡ªå·±å®ç° `Into`** â€”â€” Rust ä¼šè‡ªåŠ¨ä» `From` æ¨å¯¼å‡º `Into`ã€‚

### âœ… ç¤ºä¾‹ï¼š

```rust
struct MyInt(i32);

impl From<i32> for MyInt {
    fn from(n: i32) -> Self {
        MyInt(n)
    }
}

fn main() {
    let num: MyInt = 42.into(); // è‡ªåŠ¨æ¨å¯¼æˆ MyInt::from(42)
}
```

### âœ… ç”¨æ³•å¯¹æ¯”ï¼š

```rust
let a = MyInt::from(10);   // è°ƒç”¨ from
let b: MyInt = 10.into();  // è°ƒç”¨ intoï¼Œè‡ªåŠ¨ä½¿ç”¨ from
```

### âœ… ç”¨äºæ³›å‹å‡½æ•°

```rust
fn print_number<T: Into<i32>>(value: T) {
    let num: i32 = value.into();
    println!("Number: {}", num);
}

fn main() {
    print_number(100); // i32 è‡ªåŠ¨è½¬æ¢
}
```

---

## âš ï¸ ä¸‰ã€TryFrom Traitï¼ˆå¯èƒ½å¤±è´¥çš„è½¬æ¢ï¼‰

### âœ… å®šä¹‰ï¼š

å½“è½¬æ¢**å¯èƒ½å¤±è´¥**æ—¶ï¼Œä½¿ç”¨ `TryFrom`ã€‚

```rust
pub trait TryFrom<T>: Sized {
    type Error;
    fn try_from(value: T) -> Result<Self, Self::Error>;
}
```

### âœ… ç¤ºä¾‹ï¼š

```rust
use std::convert::TryFrom;

fn main() {
    let value: i8 = 100;
    let result = u8::try_from(value); // i8 â†’ u8ï¼Œå¯èƒ½å¤±è´¥

    match result {
        Ok(v) => println!("Success: {}", v),
        Err(e) => println!("Failed: {}", e),
    }
}
```

### âœ… è‡ªå®šä¹‰å®ç° TryFrom

```rust
use std::convert::TryFrom;

struct Positive(i32);

impl TryFrom<i32> for Positive {
    type Error = &'static str;

    fn try_from(value: i32) -> Result<Self, Self::Error> {
        if value >= 0 {
            Ok(Positive(value))
        } else {
            Err("Must be non-negative")
        }
    }
}

fn main() {
    let pos = Positive::try_from(10); // âœ… Ok
    let neg = Positive::try_from(-5); // âŒ Err

    println!("{:?}", pos); // Ok(Positive(10))
    println!("{:?}", neg); // Err("Must be non-negative")
}
```

---

## ğŸ” å››ã€TryInto Trait

### âœ… å®šä¹‰ï¼š

ä¸ `Into` ç±»ä¼¼ï¼Œ`TryInto` æ˜¯ `TryFrom` çš„æ³›å‹è¡¥å……ï¼Œç”¨äºâ€œè½¬æ¢åˆ°ç›®æ ‡ç±»å‹â€ï¼ŒåŒæ ·æ˜¯å¯èƒ½å¤±è´¥ã€‚

```rust
pub trait TryInto<T>: Sized {
    type Error;
    fn try_into(self) -> Result<T, Self::Error>;
}
```

åªè¦å®ç°äº† `TryFrom<T> for U`ï¼Œå°±èƒ½è‡ªåŠ¨ä½¿ç”¨ `TryInto<U> for T`ã€‚

### âœ… ç¤ºä¾‹ï¼š

```rust
use std::convert::TryInto;

fn main() {
    let x: i32 = -10;
    let y: Result<u32, _> = x.try_into(); // è‡ªåŠ¨è°ƒç”¨ TryFrom

    match y {
        Ok(n) => println!("Converted: {}", n),
        Err(e) => println!("Failed: {}", e),
    }
}
```

---

## ğŸ§© From / Into / TryFrom / TryInto çš„å¯¹æ¯”

| Trait        | ä¼šä¸ä¼šå¤±è´¥  | é€šå¸¸ç”±è°å®ç°  | è°ƒç”¨æ–¹å¼               | ç”¨äºæ³›å‹å‡½æ•° |
| ------------ | ------ | ------- | ------------------ | ------ |
| `From<T>`    | âŒ æ°¸ä¸å¤±è´¥ | ç›®æ ‡ç±»å‹    | `T::from(val)`     | å¦      |
| `Into<T>`    | âŒ æ°¸ä¸å¤±è´¥ | æºç±»å‹ï¼ˆæ¨å¯¼ï¼‰ | `val.into()`       | âœ… æ˜¯    |
| `TryFrom<T>` | âœ… å¯èƒ½å¤±è´¥ | ç›®æ ‡ç±»å‹    | `T::try_from(val)` | å¦      |
| `TryInto<T>` | âœ… å¯èƒ½å¤±è´¥ | æºç±»å‹ï¼ˆæ¨å¯¼ï¼‰ | `val.try_into()`   | âœ… æ˜¯    |

---

## ğŸ› ï¸ å°æŠ€å·§ä¸æ³¨æ„äº‹é¡¹

* æƒ³ç”¨ `.into()`ï¼Œå°±å®ç° `From`
* æƒ³ç”¨ `.try_into()`ï¼Œå°±å®ç° `TryFrom`
* é¿å…ä¸ºåŒä¸€ç±»å‹é—´å†™å¤šä¸ª `From` å®ç°ï¼ˆå¯èƒ½å†²çªï¼‰
* `Into`/`TryInto` é€‚åˆæ³›å‹ APIï¼Œæ¯”å¦‚å‡½æ•°å‚æ•°æ¥å—å¤šç§ç±»å‹
* `?` è¿ç®—ç¬¦å¯ä»¥ä¸ `TryFrom` æ­é…è¿”å›é”™è¯¯

---

## âœ… æ€»ç»“

| æƒ³åšçš„äº‹                  | åº”è¯¥ç”¨å“ªä¸ª Trait           |
| --------------------- | --------------------- |
| 100% å®‰å…¨çš„è½¬æ¢            | `From` / `Into`       |
| å¯èƒ½å¤±è´¥çš„è½¬æ¢               | `TryFrom` / `TryInto` |
| æä¾›è¯­ä¹‰æ˜ç¡®çš„è½¬æ¢å®ç°           | `From` / `TryFrom`    |
| å†™æ³›å‹å‡½æ•°è°ƒç”¨ `.into()`     | åªéœ€å®ç° `From`           |
| å†™æ³›å‹å‡½æ•°è°ƒç”¨ `.try_into()` | åªéœ€å®ç° `TryFrom`        |

---

å¦‚æœä½ è¿˜æƒ³æ·±å…¥äº†è§£å¦‚ä½•ä¸ºè¿™äº› Trait å®ç°ç»„åˆ Traitï¼ˆå¦‚ `impl<T> From<T> for MyType where T: Into<String>`ï¼‰ï¼Œæˆ–è€…æƒ³çœ‹ä¸€äº›å’Œ `enum`ã€`struct` æ­é…ä½¿ç”¨è¿™äº›è½¬æ¢çš„é«˜é˜¶æŠ€å·§ï¼Œä¹Ÿå¯ä»¥ç»§ç»­é—®æˆ‘ï¼

