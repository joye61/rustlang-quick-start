å¥½é—®é¢˜ ğŸ‘
# å¤šçº¿ç¨‹ç¼–ç¨‹

## å¤šçº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µ

* **çº¿ç¨‹ (Thread)**ï¼šç¨‹åºè¿è¡Œçš„æœ€å°æ‰§è¡Œå•å…ƒï¼Œå¯ä»¥å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚
* **ä¸»çº¿ç¨‹**ï¼šç¨‹åºå…¥å£æ‰€åœ¨çš„çº¿ç¨‹ï¼ˆ`main`ï¼‰ã€‚
* **å­çº¿ç¨‹**ï¼šç”±ä¸»çº¿ç¨‹æˆ–å…¶ä»–çº¿ç¨‹åˆ›å»ºï¼Œç”¨æ¥å¹¶è¡Œå¤„ç†ä»»åŠ¡ã€‚

Rust æä¾›äº†å®‰å…¨çš„å¤šçº¿ç¨‹æŠ½è±¡ï¼š`std::thread`ã€‚

## åˆ›å»ºçº¿ç¨‹

ç”¨ `std::thread::spawn` åˆ›å»ºæ–°çº¿ç¨‹ï¼Œä¼ å…¥ä¸€ä¸ªé—­åŒ…ä½œä¸ºçº¿ç¨‹è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚

```rust
use std::thread;
use std::time::Duration;

fn main() {
    let handle = thread::spawn(|| {
        for i in 1..=5 {
            println!("å­çº¿ç¨‹ï¼šç¬¬ {i} æ¬¡");
            thread::sleep(Duration::from_millis(200));
        }
    });

    for i in 1..=3 {
        println!("ä¸»çº¿ç¨‹ï¼šç¬¬ {i} æ¬¡");
        thread::sleep(Duration::from_millis(300));
    }

    handle.join().unwrap(); // ç­‰å¾…å­çº¿ç¨‹ç»“æŸ
}
```

çŸ¥è¯†ç‚¹ï¼š

* `thread::spawn` è¿”å›ä¸€ä¸ª **JoinHandle**ï¼Œä»£è¡¨å­çº¿ç¨‹ã€‚
* `join()` ç”¨æ¥é˜»å¡ç­‰å¾…å­çº¿ç¨‹ç»“æŸï¼Œå¦åˆ™ä¸»çº¿ç¨‹å¯èƒ½å…ˆé€€å‡ºã€‚

## move æ•è·ç¯å¢ƒ

é»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹é—­åŒ…ä¸ä¼šè‡ªåŠ¨è·å–å¤–éƒ¨å˜é‡ï¼ˆå› ä¸ºç”Ÿå‘½å‘¨æœŸå¯èƒ½ä¸å¤Ÿé•¿ï¼‰ã€‚
éœ€è¦ç”¨ `move` å…³é”®å­—å¼ºåˆ¶è½¬ç§»æ‰€æœ‰æƒã€‚

```rust
fn main() {
    let v = vec![1, 2, 3];

    let handle = std::thread::spawn(move || {
        println!("å­çº¿ç¨‹æ‹¿åˆ° v: {:?}", v);
    });

    handle.join().unwrap();
    // println!("{:?}", v); // âŒ v çš„æ‰€æœ‰æƒå·²è¢« move è¿›å­çº¿ç¨‹
}
```

## å¤šçº¿ç¨‹æ•°æ®å…±äº«

### ä¸å¯å˜æ•°æ®å…±äº«

* Rust é‡Œçš„ä¸å¯å˜å¼•ç”¨ï¼ˆ`&T`ï¼‰å¤©ç„¶æ˜¯**çº¿ç¨‹å®‰å…¨çš„**ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¯»ã€‚

```rust
use std::thread;

fn main() {
    let s = "hello"; // &'static str æœ¬èº«å°±æ˜¯ä¸å¯å˜æ•°æ®
    let handle = thread::spawn(move || {
        println!("å­çº¿ç¨‹è¯»ï¼š{s}");
    });
    handle.join().unwrap();
}
```

### å¯å˜æ•°æ®å…±äº«ï¼šMutex

* å¤šä¸ªçº¿ç¨‹åŒæ—¶å†™éœ€è¦**äº’æ–¥é” (Mutex)** æ¥ä¿æŠ¤ã€‚

```rust
use std::sync::{Arc, Mutex};
use std::thread;

fn main() {
    let counter = Arc::new(Mutex::new(0)); // å…±äº«æ•°æ®
    let mut handles = vec![];

    for _ in 0..10 {
        let counter = Arc::clone(&counter); // å¼•ç”¨è®¡æ•°ï¼Œå®‰å…¨å…±äº«
        let handle = thread::spawn(move || {
            let mut num = counter.lock().unwrap(); // è·å–é”
            *num += 1;
        });
        handles.push(handle);
    }

    for h in handles {
        h.join().unwrap();
    }

    println!("ç»“æœ = {}", *counter.lock().unwrap());
}
```

çŸ¥è¯†ç‚¹ï¼š

* `Mutex<T>`ï¼šä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è®¿é—®æ•°æ®ã€‚
* `Arc<T>`ï¼šåŸå­å¼•ç”¨è®¡æ•°ï¼Œå…è®¸å¤šçº¿ç¨‹å…±äº«æ‰€æœ‰æƒã€‚
* å¸¸è§ç»„åˆï¼š`Arc<Mutex<T>>`


## çº¿ç¨‹é€šä¿¡ï¼šChannel

Rust æä¾› **æ¶ˆæ¯ä¼ é€’ï¼ˆChannelï¼‰** æ–¹å¼åœ¨çº¿ç¨‹é—´é€šä¿¡ã€‚

```rust
use std::sync::mpsc; // å¤šç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…
use std::thread;
use std::time::Duration;

fn main() {
    let (tx, rx) = mpsc::channel();

    thread::spawn(move || {
        let msgs = vec!["ä½ å¥½", "Rust", "å¤šçº¿ç¨‹"];
        for msg in msgs {
            tx.send(msg).unwrap();
            thread::sleep(Duration::from_millis(500));
        }
    });

    for received in rx {
        println!("ä¸»çº¿ç¨‹æ”¶åˆ°: {received}");
    }
}
```

çŸ¥è¯†ç‚¹ï¼š

* `mpsc::channel()`ï¼šè¿”å›ä¸€ä¸ª `(å‘é€ç«¯, æ¥æ”¶ç«¯)`ã€‚
* `send()` å‘é€æ¶ˆæ¯ï¼Œ`recv()` æˆ– `for` å¾ªç¯æ¥æ”¶æ¶ˆæ¯ã€‚
* `tx.clone()` å¯ä»¥äº§ç”Ÿå¤šä¸ªç”Ÿäº§è€…ã€‚


## çº¿ç¨‹å®‰å…¨ï¼ˆSync & Send Traitï¼‰

* **Send**ï¼šç±»å‹èƒ½å®‰å…¨åœ°åœ¨**çº¿ç¨‹é—´è½¬ç§»æ‰€æœ‰æƒ**ã€‚
* **Sync**ï¼šç±»å‹èƒ½å®‰å…¨åœ°åœ¨**å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«å¼•ç”¨**ã€‚
* å‡ ä¹æ‰€æœ‰åŸºç¡€ç±»å‹éƒ½å®ç°äº† `Send` + `Sync`ã€‚
  ç‰¹ä¾‹ï¼š`Rc<T>` ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆç”¨ `Arc<T>` ä»£æ›¿ï¼‰ã€‚


## å¸¸è§æ¨¡å¼æ€»ç»“

* **ä¸€æ¬¡æ€§ä»»åŠ¡**ï¼š`thread::spawn` + `join`
* **æ•°æ®å…±äº«**ï¼š`Arc<Mutex<T>>`
* **ä»»åŠ¡é€šä¿¡**ï¼š`mpsc::channel`
* **å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡**ï¼šå¤šä¸ªçº¿ç¨‹ + `join`
* **å¹¶è¡Œè®¡ç®—**ï¼šå¯ç”¨ `rayon` åº“ï¼ˆé«˜çº§æŠ½è±¡ï¼‰

## ç¤ºä¾‹ï¼šç»Ÿè®¡å¤šçº¿ç¨‹å’Œæ¶ˆæ¯ä¼ é€’

```rust
use std::sync::{mpsc, Arc, Mutex};
use std::thread;

fn main() {
    let (tx, rx) = mpsc::channel();
    let counter = Arc::new(Mutex::new(0));
    let mut handles = vec![];

    for i in 0..5 {
        let tx = tx.clone();
        let counter = Arc::clone(&counter);

        let handle = thread::spawn(move || {
            let mut num = counter.lock().unwrap();
            *num += 1;
            tx.send(format!("çº¿ç¨‹ {i} å®Œæˆ")).unwrap();
        });

        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }

    for msg in rx {
        println!("ä¸»çº¿ç¨‹æ”¶åˆ°: {msg}");
    }

    println!("æœ€ç»ˆè®¡æ•°: {}", *counter.lock().unwrap());
}
```

# æ€»ç»“

Rust çš„å¤šçº¿ç¨‹æ ¸å¿ƒè¯­æ³•å’ŒçŸ¥è¯†ç‚¹ï¼š

1. **åˆ›å»ºçº¿ç¨‹**ï¼š`thread::spawn`
2. **ç­‰å¾…çº¿ç¨‹ç»“æŸ**ï¼š`join`
3. **move æ•è·å˜é‡**ï¼šæ‰€æœ‰æƒè½¬ç§»è¿›çº¿ç¨‹
4. **æ•°æ®å…±äº«**ï¼š`Arc<Mutex<T>>`
5. **çº¿ç¨‹é€šä¿¡**ï¼š`mpsc::channel`
6. **çº¿ç¨‹å®‰å…¨ä¿è¯**ï¼š`Send` å’Œ `Sync` trait

